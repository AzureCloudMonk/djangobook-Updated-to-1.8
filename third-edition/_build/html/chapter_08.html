<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 8: Advanced Templates &mdash; Mastering Django</title>
    
    <link rel="stylesheet" href="_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Mastering Django" href="index.html" />
    <link rel="next" title="Chapter 9: Advanced Models" href="chapter_09.html" />
    <link rel="prev" title="Chapter 7: Advanced Views and URLconfs" href="chapter_07.html" /> 
  </head>
  <body role="document">
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="index.html">Mastering Django</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="chapter_07.html" title="Chapter 7: Advanced Views and URLconfs"
             accesskey="P">previous</a> |
          <a href="chapter_09.html" title="Chapter 9: Advanced Models"
             accesskey="N">next</a> |
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="chapter-8-advanced-templates">
<h1>Chapter 8: Advanced Templates<a class="headerlink" href="#chapter-8-advanced-templates" title="Permalink to this headline">¶</a></h1>
<p>Although most of your interactions with Django&#8217;s template language will be in
the role of template author, you may want to customize and extend the template
engine &#8211; either to make it do something it doesn&#8217;t already do, or to make your
job easier in some other way.</p>
<p>This chapter delves deep into the guts of Django&#8217;s template system. It covers
what you need to know if you plan to extend the system or if you&#8217;re just
curious about how it works. It also covers the auto-escaping feature, a
security measure you&#8217;ll no doubt notice over time as you continue to use
Django.</p>
<div class="section" id="template-language-review">
<h2>Template Language Review<a class="headerlink" href="#template-language-review" title="Permalink to this headline">¶</a></h2>
<p>First, let&#8217;s quickly review a number of terms introduced in Chapter 3:</p>
<ul>
<li><p class="first">A <em>template</em> is a text document, or a normal Python string, that is
marked up using the Django template language. A template can contain
template tags and variables.</p>
</li>
<li><p class="first">A <em>template tag</em> is a symbol within a template that does something. This
definition is deliberately vague. For example, a template tag can produce
content, serve as a control structure (an <code class="docutils literal"><span class="pre">if</span></code> statement or <code class="docutils literal"><span class="pre">for</span></code>
loop), grab content from a database, or enable access to other template
tags.</p>
<p>Template tags are surrounded by <code class="docutils literal"><span class="pre">{%</span></code> and <code class="docutils literal"><span class="pre">%}</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>{% if is_logged_in %}
    Thanks for logging in!
{% else %}
    Please log in.
{% endif %}
</pre></div>
</div>
</li>
<li><p class="first">A <em>variable</em> is a symbol within a template that outputs a value.</p>
<p>Variable tags are surrounded by <code class="docutils literal"><span class="pre">{{</span></code> and <code class="docutils literal"><span class="pre">}}</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>My first name is {{ first_name }}. My last name is {{ last_name }}.
</pre></div>
</div>
</li>
<li><p class="first">A <em>context</em> is a <code class="docutils literal"><span class="pre">name-&gt;value</span></code> mapping (similar to a Python
dictionary) that is passed to a template.</p>
</li>
<li><p class="first">A template <em>renders</em> a context by replacing the variable &#8220;holes&#8221; with
values from the context and executing all template tags.</p>
</li>
</ul>
<p>For more details about the basics of these terms, refer back to Chapter 3.</p>
<p>The rest of this chapter discusses ways of extending the template engine. First,
though, let&#8217;s take a quick look at a few internals left out of Chapter 3 for
simplicity.</p>
</div>
<div class="section" id="requestcontext-and-context-processors">
<h2>RequestContext and Context Processors<a class="headerlink" href="#requestcontext-and-context-processors" title="Permalink to this headline">¶</a></h2>
<p>When rendering a template, you need a context. This can be an instance of
<code class="docutils literal"><span class="pre">django.template.Context</span></code>, but Django also comes with a subclass,
<code class="docutils literal"><span class="pre">django.template.RequestContext</span></code>, that acts slightly differently.
<code class="docutils literal"><span class="pre">RequestContext</span></code> adds a bunch of variables to your template context by
default &#8211; things like the <code class="docutils literal"><span class="pre">HttpRequest</span></code> object or information about the
currently logged-in user. The <code class="docutils literal"><span class="pre">render()</span></code> shortcut creates a <code class="docutils literal"><span class="pre">RequestContext</span></code>
unless it is passed a different context instance explicitly.</p>
<p>Use <code class="docutils literal"><span class="pre">RequestContext</span></code> when you don&#8217;t want to have to specify the same set of
variables in a series of templates. For example, consider these two views:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">loader</span><span class="p">,</span> <span class="n">Context</span>

<span class="k">def</span> <span class="nf">view_1</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;template1.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span>
        <span class="s">&#39;app&#39;</span><span class="p">:</span> <span class="s">&#39;My app&#39;</span><span class="p">,</span>
        <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="s">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">],</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;I am view 1.&#39;</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">view_2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;template2.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span>
        <span class="s">&#39;app&#39;</span><span class="p">:</span> <span class="s">&#39;My app&#39;</span><span class="p">,</span>
        <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="s">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">],</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;I am the second view.&#39;</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>(Note that we&#8217;re deliberately <em>not</em> using the <code class="docutils literal"><span class="pre">render()</span></code> shortcut
in these examples &#8211; we&#8217;re manually loading the templates, constructing the
context objects and rendering the templates. We&#8217;re &#8220;spelling out&#8221; all of the
steps for the purpose of clarity.)</p>
<p>Each view passes the same three variables &#8211; <code class="docutils literal"><span class="pre">app</span></code>, <code class="docutils literal"><span class="pre">user</span></code> and
<code class="docutils literal"><span class="pre">ip_address</span></code> &#8211; to its template. Wouldn&#8217;t it be nice if we could remove that
redundancy?</p>
<p><code class="docutils literal"><span class="pre">RequestContext</span></code> and <strong>context processors</strong> were created to solve this
problem. Context processors let you specify a number of variables that get set
in each context automatically &#8211; without you having to specify the variables in
each <code class="docutils literal"><span class="pre">render()</span></code> call. The catch is that you have to use
<code class="docutils literal"><span class="pre">RequestContext</span></code> instead of <code class="docutils literal"><span class="pre">Context</span></code> when you render a template.</p>
<p>The most low-level way of using context processors is to create some processors
and pass them to <code class="docutils literal"><span class="pre">RequestContext</span></code>. Here&#8217;s how the above example could be
written with context processors:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">loader</span><span class="p">,</span> <span class="n">RequestContext</span>

<span class="k">def</span> <span class="nf">custom_proc</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="s">&quot;A context processor that provides &#39;app&#39;, &#39;user&#39; and &#39;ip_address&#39;.&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;app&#39;</span><span class="p">:</span> <span class="s">&#39;My app&#39;</span><span class="p">,</span>
        <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="s">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">view_1</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;template1.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;I am view 1.&#39;</span><span class="p">},</span>
            <span class="n">processors</span><span class="o">=</span><span class="p">[</span><span class="n">custom_proc</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">view_2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;template2.html&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;I am the second view.&#39;</span><span class="p">},</span>
            <span class="n">processors</span><span class="o">=</span><span class="p">[</span><span class="n">custom_proc</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>Let&#8217;s step through this code:</p>
<ul class="simple">
<li>First, we define a function <code class="docutils literal"><span class="pre">custom_proc</span></code>. This is a context processor
&#8211; it takes an <code class="docutils literal"><span class="pre">HttpRequest</span></code> object and returns a dictionary of
variables to use in the template context. That&#8217;s all it does.</li>
<li>We&#8217;ve changed the two view functions to use <code class="docutils literal"><span class="pre">RequestContext</span></code> instead
of <code class="docutils literal"><span class="pre">Context</span></code>. There are two differences in how the context is
constructed. One, <code class="docutils literal"><span class="pre">RequestContext</span></code> requires the first argument to be an
<code class="docutils literal"><span class="pre">HttpRequest</span></code> object &#8211; the one that was passed into the view function
in the first place (<code class="docutils literal"><span class="pre">request</span></code>). Two, <code class="docutils literal"><span class="pre">RequestContext</span></code> takes an
optional <code class="docutils literal"><span class="pre">processors</span></code> argument, which is a list or tuple of context
processor functions to use. Here, we pass in <code class="docutils literal"><span class="pre">custom_proc</span></code>, the custom
processor we defined above.</li>
<li>Each view no longer has to include <code class="docutils literal"><span class="pre">app</span></code>, <code class="docutils literal"><span class="pre">user</span></code> or <code class="docutils literal"><span class="pre">ip_address</span></code> in
its context construction, because those are provided by <code class="docutils literal"><span class="pre">custom_proc</span></code>.</li>
<li>Each view <em>still</em> has the flexibility to introduce any custom template
variables it might need. In this example, the <code class="docutils literal"><span class="pre">message</span></code> template
variable is set differently in each view.</li>
</ul>
<p>In Chapter 3, we introduced the <code class="docutils literal"><span class="pre">render()</span></code> shortcut, which saves
you from having to call <code class="docutils literal"><span class="pre">loader.get_template()</span></code>, then create a <code class="docutils literal"><span class="pre">Context</span></code>,
then call the <code class="docutils literal"><span class="pre">render()</span></code> method on the template. In order to demonstrate the
lower-level workings of context processors, the above examples didn&#8217;t use
<code class="docutils literal"><span class="pre">render()</span></code>, . But it&#8217;s possible &#8211; and preferable &#8211; to use
context processors with <code class="docutils literal"><span class="pre">render()</span></code>. Do this with the
<code class="docutils literal"><span class="pre">context_instance</span></code> argument, like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>

<span class="k">def</span> <span class="nf">custom_proc</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="s">&quot;A context processor that provides &#39;app&#39;, &#39;user&#39; and &#39;ip_address&#39;.&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;app&#39;</span><span class="p">:</span> <span class="s">&#39;My app&#39;</span><span class="p">,</span>
        <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="s">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">view_1</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;template1.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;I am view 1.&#39;</span><span class="p">},</span>
        <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">processors</span><span class="o">=</span><span class="p">[</span><span class="n">custom_proc</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">view_2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;template2.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;I am the second view.&#39;</span><span class="p">},</span>
        <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">processors</span><span class="o">=</span><span class="p">[</span><span class="n">custom_proc</span><span class="p">]))</span>
</pre></div>
</div>
<p>Here, we&#8217;ve trimmed down each view&#8217;s template rendering code to a single
(wrapped) line.</p>
<p>This is an improvement, but, evaluating the conciseness of this code, we have
to admit we&#8217;re now almost overdosing on the <em>other</em> end of the spectrum. We&#8217;ve
removed redundancy in data (our template variables) at the cost of adding
redundancy in code (in the <code class="docutils literal"><span class="pre">processors</span></code> call). Using context processors
doesn&#8217;t save you much typing if you have to type <code class="docutils literal"><span class="pre">processors</span></code> all the time.</p>
<p>For that reason, Django provides support for <em>global</em> context processors. The
<code class="docutils literal"><span class="pre">context_processors</span></code> setting (in your <code class="docutils literal"><span class="pre">settings.py</span></code>) designates
which context processors should <em>always</em> be applied to <code class="docutils literal"><span class="pre">RequestContext</span></code>. This
removes the need to specify <code class="docutils literal"><span class="pre">processors</span></code> each time you use
<code class="docutils literal"><span class="pre">RequestContext</span></code>.</p>
<p>By default, <code class="docutils literal"><span class="pre">context_processors</span></code> is set to the following:</p>
<div class="highlight-python"><div class="highlight"><pre>&#39;context_processors&#39;: [
            &#39;django.template.context_processors.debug&#39;,
            &#39;django.template.context_processors.request&#39;,
            &#39;django.contrib.auth.context_processors.auth&#39;,
            &#39;django.contrib.messages.context_processors.messages&#39;,
        ],
</pre></div>
</div>
<p>This setting is a list of callables that use the same interface as our
<code class="docutils literal"><span class="pre">custom_proc</span></code> function above &#8211; functions that take a request object as their
argument and return a dictionary of items to be merged into the context. Note
that the values in <code class="docutils literal"><span class="pre">context_processors</span></code> are specified as <em>strings</em>,
which means the processors are required to be somewhere on your Python path
(so you can refer to them from the setting).</p>
<p>Each processor is applied in order. That is, if one processor adds a variable
to the context and a second processor adds a variable with the same name, the
second will override the first.</p>
<p>Django provides a number of simple context processors, including the ones that
are enabled by default:</p>
<div class="section" id="auth">
<h3>auth<a class="headerlink" href="#auth" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">django.contrib.auth.context_processors.auth</span></code></p>
<p>If this processor is enabled, every <code class="docutils literal"><span class="pre">RequestContext</span></code> will contain these
variables:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">user</span></code> &#8211; An <code class="docutils literal"><span class="pre">auth.User</span></code> instance representing the currently
logged-in user (or an <code class="docutils literal"><span class="pre">AnonymousUser</span></code> instance, if the client isn&#8217;t
logged in).</li>
<li><code class="docutils literal"><span class="pre">perms</span></code> &#8211; An instance of
<code class="docutils literal"><span class="pre">django.contrib.auth.context_processors.PermWrapper</span></code>, representing the
permissions that the currently logged-in user has.</li>
</ul>
</div>
<div class="section" id="debug">
<h3>debug<a class="headerlink" href="#debug" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">django.template.context_processors.debug</span></code></p>
<p>If this processor is enabled, every <code class="docutils literal"><span class="pre">RequestContext</span></code> will contain these two
variables &#8211; but only if your <code class="docutils literal"><span class="pre">DEBUG</span></code> setting is set to <code class="docutils literal"><span class="pre">True</span></code> and
the request&#8217;s IP address (<code class="docutils literal"><span class="pre">request.META['REMOTE_ADDR']</span></code>) is in the
<code class="docutils literal"><span class="pre">INTERNAL_IPS</span></code> setting:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">debug</span></code> &#8211; <code class="docutils literal"><span class="pre">True</span></code>. You can use this in templates to test whether
you&#8217;re in <code class="docutils literal"><span class="pre">DEBUG</span></code> mode.</li>
<li><code class="docutils literal"><span class="pre">sql_queries</span></code> &#8211; A list of <code class="docutils literal"><span class="pre">{'sql':</span> <span class="pre">...,</span> <span class="pre">'time':</span> <span class="pre">...}</span></code> dictionaries,
representing every SQL query that has happened so far during the request
and how long it took. The list is in order by query and lazily generated
on access.</li>
</ul>
</div>
<div class="section" id="i18n">
<h3>i18n<a class="headerlink" href="#i18n" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">django.template.context_processors.i18n</span></code></p>
<p>If this processor is enabled, every <code class="docutils literal"><span class="pre">RequestContext</span></code> will contain these two
variables:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">LANGUAGES</span></code> &#8211; The value of the <code class="docutils literal"><span class="pre">LANGUAGES</span></code> setting.</li>
<li><code class="docutils literal"><span class="pre">LANGUAGE_CODE</span></code> &#8211; <code class="docutils literal"><span class="pre">request.LANGUAGE_CODE</span></code>, if it exists. Otherwise,
the value of the <code class="docutils literal"><span class="pre">LANGUAGE_CODE</span></code> setting.</li>
</ul>
</div>
<div class="section" id="media">
<h3>media<a class="headerlink" href="#media" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">django.template.context_processors.media</span></code></p>
<p>If this processor is enabled, every <code class="docutils literal"><span class="pre">RequestContext</span></code> will contain a variable
<code class="docutils literal"><span class="pre">MEDIA_URL</span></code>, providing the value of the <code class="docutils literal"><span class="pre">MEDIA_URL</span></code> setting.</p>
</div>
<div class="section" id="static">
<h3>static<a class="headerlink" href="#static" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">django.template.context_processors.static</span></code></p>
<p>If this processor is enabled, every <code class="docutils literal"><span class="pre">RequestContext</span></code> will contain a variable
<code class="docutils literal"><span class="pre">STATIC_URL</span></code>, providing the value of the <code class="docutils literal"><span class="pre">STATIC_URL</span></code> setting.</p>
</div>
<div class="section" id="csrf">
<h3>csrf<a class="headerlink" href="#csrf" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">django.template.context_processors.csrf</span></code></p>
<p>This processor adds a token that is needed by the <code class="docutils literal"><span class="pre">csrf_token</span></code> template
tag for protection against Cross Site Request Forgeries (see chapter 21).</p>
</div>
<div class="section" id="request">
<h3>request<a class="headerlink" href="#request" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">django.template.context_processors.request</span></code></p>
<p>If this processor is enabled, every <code class="docutils literal"><span class="pre">RequestContext</span></code> will contain a variable
<code class="docutils literal"><span class="pre">request</span></code>, which is the current <code class="xref py py-class docutils literal"><span class="pre">HttpRequest</span></code>.</p>
</div>
<div class="section" id="messages">
<h3>messages<a class="headerlink" href="#messages" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">django.contrib.messages.context_processors.messages</span></code></p>
<p>If this processor is enabled, every <code class="docutils literal"><span class="pre">RequestContext</span></code> will contain these two
variables:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">messages</span></code> &#8211; A list of messages (as strings) that have been set
via the messages framework (see Appendix H).</li>
<li><code class="docutils literal"><span class="pre">DEFAULT_MESSAGE_LEVELS</span></code> &#8211; A mapping of the message level names to
their numeric value.</li>
</ul>
</div>
</div>
<div class="section" id="guidelines-for-writing-your-own-context-processors">
<h2>Guidelines for Writing Your Own Context Processors<a class="headerlink" href="#guidelines-for-writing-your-own-context-processors" title="Permalink to this headline">¶</a></h2>
<p>A context processor has a very simple interface: It&#8217;s just a Python function
that takes one argument, an <code class="xref py py-class docutils literal"><span class="pre">HttpRequest</span></code> object, and
returns a dictionary that gets added to the template context. Each context
processor <em>must</em> return a dictionary.</p>
<p>Here are a few tips for rolling your own:</p>
<ul class="simple">
<li>Make each context processor responsible for the smallest subset of
functionality possible. It&#8217;s easy to use multiple processors, so you
might as well split functionality into logical pieces for future reuse.</li>
<li>Keep in mind that any context processor in <code class="docutils literal"><span class="pre">TEMPLATE_CONTEXT_PROCESSORS</span></code>
will be available in <em>every</em> template powered by that settings file, so
try to pick variable names that are unlikely to conflict with variable
names your templates might be using independently. As variable names are
case-sensitive, it&#8217;s not a bad idea to use all caps for variables that a
processor provides.</li>
<li>Custom context processors can live anywhere in your code base. All Django
cares about is that your custom context processors are pointed to by the
<code class="docutils literal"><span class="pre">'context_processors'</span></code> option in your <code class="docutils literal"><span class="pre">TEMPLATES</span></code> setting — or
the <code class="docutils literal"><span class="pre">context_processors</span></code> argument of <code class="xref py py-class docutils literal"><span class="pre">Engine</span></code> if
you&#8217;re using it directly.  With that said, the convention is to save them in
a file called <code class="docutils literal"><span class="pre">context_processors.py</span></code> within your app or project.</li>
</ul>
</div>
<div class="section" id="automatic-html-escaping">
<h2>Automatic HTML Escaping<a class="headerlink" href="#automatic-html-escaping" title="Permalink to this headline">¶</a></h2>
<p>When generating HTML from templates, there&#8217;s always a risk that a variable will
include characters that affect the resulting HTML. For example, consider this
template fragment:</p>
<div class="highlight-python"><div class="highlight"><pre>Hello, {{ name }}.
</pre></div>
</div>
<p>At first, this seems like a harmless way to display a user&#8217;s name, but consider
what would happen if the user entered his name as this:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;script&gt;alert(&#39;hello&#39;)&lt;/script&gt;
</pre></div>
</div>
<p>With this name value, the template would be rendered as:</p>
<div class="highlight-python"><div class="highlight"><pre>Hello, &lt;script&gt;alert(&#39;hello&#39;)&lt;/script&gt;
</pre></div>
</div>
<p>...which means the browser would pop-up a JavaScript alert box!</p>
<p>Similarly, what if the name contained a <code class="docutils literal"><span class="pre">'&lt;'</span></code> symbol, like this?</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;b&gt;username
</pre></div>
</div>
<p>That would result in a rendered template like this:</p>
<div class="highlight-python"><div class="highlight"><pre>Hello, &lt;b&gt;username
</pre></div>
</div>
<p>...which, in turn, would result in the remainder of the Web page being bolded!</p>
<p>Clearly, user-submitted data shouldn&#8217;t be trusted blindly and inserted directly
into your Web pages, because a malicious user could use this kind of hole to
do potentially bad things. This type of security exploit is called a
Cross Site Scripting (XSS) attack. (For more on security, see Chapter 21.)</p>
<p>To avoid this problem, you have two options:</p>
<ul class="simple">
<li>One, you can make sure to run each untrusted variable through the
<code class="docutils literal"><span class="pre">escape</span></code> filter, which converts potentially harmful HTML characters to
unharmful ones. This was the default solution in Django for its first few
years, but the problem is that it puts the onus on <em>you</em>, the developer /
template author, to ensure you&#8217;re escaping everything. It&#8217;s easy to forget
to escape data.</li>
<li>Two, you can take advantage of Django&#8217;s automatic HTML escaping. The
remainder of this section describes how auto-escaping works.</li>
</ul>
<p>By default in Django, every template automatically escapes the output
of every variable tag. Specifically, these five characters are
escaped:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&lt;</span></code> is converted to <code class="docutils literal"><span class="pre">&amp;lt;</span></code></li>
<li><code class="docutils literal"><span class="pre">&gt;</span></code> is converted to <code class="docutils literal"><span class="pre">&amp;gt;</span></code></li>
<li><code class="docutils literal"><span class="pre">'</span></code> (single quote) is converted to <code class="docutils literal"><span class="pre">&amp;#39;</span></code></li>
<li><code class="docutils literal"><span class="pre">&quot;</span></code> (double quote) is converted to <code class="docutils literal"><span class="pre">&amp;quot;</span></code></li>
<li><code class="docutils literal"><span class="pre">&amp;</span></code> is converted to <code class="docutils literal"><span class="pre">&amp;amp;</span></code></li>
</ul>
<p>Again, we stress that this behavior is on by default. If you&#8217;re using Django&#8217;s
template system, you&#8217;re protected.</p>
<div class="section" id="how-to-turn-it-off">
<h3>How to Turn it Off<a class="headerlink" href="#how-to-turn-it-off" title="Permalink to this headline">¶</a></h3>
<p>If you don&#8217;t want data to be auto-escaped, on a per-site, per-template level or
per-variable level, you can turn it off in several ways.</p>
<p>Why would you want to turn it off? Because sometimes, template variables
contain data that you <em>intend</em> to be rendered as raw HTML, in which case you
don&#8217;t want their contents to be escaped. For example, you might store a blob of
trusted HTML in your database and want to embed that directly into your
template. Or, you might be using Django&#8217;s template system to produce text that
is <em>not</em> HTML &#8211; like an e-mail message, for instance.</p>
</div>
<div class="section" id="for-individual-variables">
<h3>For Individual Variables<a class="headerlink" href="#for-individual-variables" title="Permalink to this headline">¶</a></h3>
<p>To disable auto-escaping for an individual variable, use the <code class="docutils literal"><span class="pre">safe</span></code> filter:</p>
<div class="highlight-python"><div class="highlight"><pre>This will be escaped: {{ data }}
This will not be escaped: {{ data|safe }}
</pre></div>
</div>
<p>Think of <em>safe</em> as shorthand for <em>safe from further escaping</em> or <em>can be
safely interpreted as HTML</em>. In this example, if <code class="docutils literal"><span class="pre">data</span></code> contains <code class="docutils literal"><span class="pre">'&lt;b&gt;'</span></code>,
the output will be:</p>
<div class="highlight-python"><div class="highlight"><pre>This will be escaped: &amp;lt;b&amp;gt;
This will not be escaped: &lt;b&gt;
</pre></div>
</div>
</div>
<div class="section" id="for-template-blocks">
<h3>For Template Blocks<a class="headerlink" href="#for-template-blocks" title="Permalink to this headline">¶</a></h3>
<p>To control auto-escaping for a template, wrap the template (or just a
particular section of the template) in the <code class="docutils literal"><span class="pre">autoescape</span></code> tag, like so:</p>
<div class="highlight-python"><div class="highlight"><pre>{% autoescape off %}
    Hello {{ name }}
{% endautoescape %}
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">autoescape</span></code> tag takes either <code class="docutils literal"><span class="pre">on</span></code> or <code class="docutils literal"><span class="pre">off</span></code> as its argument. At
times, you might want to force auto-escaping when it would otherwise be
disabled. Here is an example template:</p>
<div class="highlight-python"><div class="highlight"><pre>Auto-escaping is on by default. Hello {{ name }}

{% autoescape off %}
    This will not be auto-escaped: {{ data }}.

    Nor this: {{ other_data }}
    {% autoescape on %}
        Auto-escaping applies again: {{ name }}
    {% endautoescape %}
{% endautoescape %}
</pre></div>
</div>
<p>The auto-escaping tag passes its effect on to templates that extend the
current one as well as templates included via the <code class="docutils literal"><span class="pre">include</span></code> tag, just like
all block tags. For example:</p>
<div class="highlight-python"><div class="highlight"><pre># base.html

{% autoescape off %}
&lt;h1&gt;{% block title %}{% endblock %}&lt;/h1&gt;
{% block content %}
{% endblock %}
{% endautoescape %}

# child.html

{% extends &quot;base.html&quot; %}
{% block title %}This &amp;amp; that{% endblock %}
{% block content %}{{ greeting }}{% endblock %}
</pre></div>
</div>
<p>Because auto-escaping is turned off in the base template, it will also be
turned off in the child template, resulting in the following rendered
HTML when the <code class="docutils literal"><span class="pre">greeting</span></code> variable contains the string <code class="docutils literal"><span class="pre">&lt;b&gt;Hello!&lt;/b&gt;</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;h1&gt;This &amp; that&lt;/h1&gt;
&lt;b&gt;Hello!&lt;/b&gt;
</pre></div>
</div>
<p>Generally, template authors don&#8217;t need to worry about auto-escaping very much.
Developers on the Python side (people writing views and custom filters) need to
think about the cases in which data shouldn&#8217;t be escaped, and mark data
appropriately, so things work in the template.</p>
<p>If you&#8217;re creating a template that might be used in situations where you&#8217;re
not sure whether auto-escaping is enabled, then add an <code class="docutils literal"><span class="pre">escape</span></code> filter to any
variable that needs escaping. When auto-escaping is on, there&#8217;s no danger of
the <code class="docutils literal"><span class="pre">escape</span></code> filter <em>double-escaping</em> data &#8211; the <code class="docutils literal"><span class="pre">escape</span></code> filter does not
affect auto-escaped variables.</p>
</div>
<div class="section" id="automatic-escaping-of-string-literals-in-filter-arguments">
<h3>Automatic Escaping of String Literals in Filter Arguments<a class="headerlink" href="#automatic-escaping-of-string-literals-in-filter-arguments" title="Permalink to this headline">¶</a></h3>
<p>As we mentioned earlier, filter arguments can be strings:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{{</span> <span class="n">data</span><span class="o">|</span><span class="n">default</span><span class="p">:</span><span class="s">&quot;This is a string literal.&quot;</span> <span class="p">}}</span>
</pre></div>
</div>
<p>All string literals are inserted <em>without</em> any automatic escaping into the
template &#8211; they act as if they were all passed through the <code class="docutils literal"><span class="pre">safe</span></code> filter.
The reasoning behind this is that the template author is in control of what
goes into the string literal, so they can make sure the text is correctly
escaped when the template is written.</p>
<p>This means you would write</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{{</span> <span class="n">data</span><span class="o">|</span><span class="n">default</span><span class="p">:</span><span class="s">&quot;3 &amp;lt; 2&quot;</span> <span class="p">}}</span>
</pre></div>
</div>
<p>...rather than</p>
<div class="highlight-python"><div class="highlight"><pre>{{ data|default:&quot;3 &lt; 2&quot; }}  &lt;-- Bad! Don&#39;t do this.
</pre></div>
</div>
<p>This doesn&#8217;t affect what happens to data coming from the variable itself.
The variable&#8217;s contents are still automatically escaped, if necessary, because
they&#8217;re beyond the control of the template author.</p>
</div>
</div>
<div class="section" id="inside-template-loading">
<h2>Inside Template Loading<a class="headerlink" href="#inside-template-loading" title="Permalink to this headline">¶</a></h2>
<p>Generally, you&#8217;ll store templates in files on your filesystem rather than
using the low-level <code class="xref py py-class docutils literal"><span class="pre">Template</span></code> API yourself. Save
templates in a directory specified as a <strong>template directory</strong>.</p>
<p>Django searches for template directories in a number of places, depending on
your template loading settings (see &#8220;Loader types&#8221; below), but the most basic
way of specifying template directories is by using the <code class="docutils literal"><span class="pre">DIRS</span></code> option.</p>
<div class="section" id="the-dirs-option">
<h3>The <code class="docutils literal"><span class="pre">DIRS</span></code> option<a class="headerlink" href="#the-dirs-option" title="Permalink to this headline">¶</a></h3>
<p>Tell Django what your template directories are by using the <code class="docutils literal"><span class="pre">DIRS</span></code> option in the <code class="docutils literal"><span class="pre">TEMPLATES</span></code> setting in your settings
file — or the <code class="docutils literal"><span class="pre">dirs</span></code> argument of <code class="xref py py-class docutils literal"><span class="pre">Engine</span></code>. This
should be set to a list of strings that contain full paths to your template
directories:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
        <span class="s">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s">&#39;/home/html/templates/lawrence.com&#39;</span><span class="p">,</span>
            <span class="s">&#39;/home/html/templates/default&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Your templates can go anywhere you want, as long as the directories and
templates are readable by the Web server. They can have any extension you want,
such as <code class="docutils literal"><span class="pre">.html</span></code> or <code class="docutils literal"><span class="pre">.txt</span></code>, or they can have no extension at all.</p>
<p>Note that these paths should use Unix-style forward slashes, even on Windows.</p>
</div>
<div class="section" id="loader-types">
<span id="template-loaders"></span><h3>Loader types<a class="headerlink" href="#loader-types" title="Permalink to this headline">¶</a></h3>
<p>By default, Django uses a filesystem-based template loader, but Django comes
with a few other template loaders, which know how to load templates from other
sources; the most commonly used of them, the apps loader, is described below.</p>
<div class="section" id="filesystem-loader">
<h4>Filesystem loader<a class="headerlink" href="#filesystem-loader" title="Permalink to this headline">¶</a></h4>
<dl class="class">
<dt id="filesystem.Loader">
<em class="property">class </em><code class="descclassname">filesystem.</code><code class="descname">Loader</code><a class="headerlink" href="#filesystem.Loader" title="Permalink to this definition">¶</a></dt>
<dd><p>Loads templates from the filesystem, according to
<code class="docutils literal"><span class="pre">DIRS</span> <span class="pre">&lt;TEMPLATES-DIRS&gt;</span></code>.</p>
<p>This loader is enabled by default. However it won&#8217;t find any templates
until you set <code class="docutils literal"><span class="pre">DIRS</span> <span class="pre">&lt;TEMPLATES-DIRS&gt;</span></code> to a non-empty list:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[{</span>
    <span class="s">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
    <span class="s">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)],</span>
<span class="p">}]</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="app-directories-loader">
<h4>App directories loader<a class="headerlink" href="#app-directories-loader" title="Permalink to this headline">¶</a></h4>
<dl class="class">
<dt id="app_directories.Loader">
<em class="property">class </em><code class="descclassname">app_directories.</code><code class="descname">Loader</code><a class="headerlink" href="#app_directories.Loader" title="Permalink to this definition">¶</a></dt>
<dd><p>Loads templates from Django apps on the filesystem. For each app in
<code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>, the loader looks for a <code class="docutils literal"><span class="pre">templates</span></code>
subdirectory. If the directory exists, Django looks for templates in there.</p>
<p>This means you can store templates with your individual apps. This also
makes it easy to distribute Django apps with default templates.</p>
<p>For example, for this setting:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;myproject.reviews&#39;</span><span class="p">,</span> <span class="s">&#39;myproject.music&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>...then <code class="docutils literal"><span class="pre">get_template('foo.html')</span></code> will look for <code class="docutils literal"><span class="pre">foo.html</span></code> in these
directories, in this order:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">/path/to/myproject/reviews/templates/</span></code></li>
<li><code class="docutils literal"><span class="pre">/path/to/myproject/music/templates/</span></code></li>
</ul>
<p>... and will use the one it finds first.</p>
<p>The order of <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code> is significant! For example, if you
want to customize the Django admin, you might choose to override the
standard <code class="docutils literal"><span class="pre">admin/base_site.html</span></code> template, from <code class="docutils literal"><span class="pre">django.contrib.admin</span></code>,
with your own <code class="docutils literal"><span class="pre">admin/base_site.html</span></code> in <code class="docutils literal"><span class="pre">myproject.reviewss</span></code>. You must
then make sure that your <code class="docutils literal"><span class="pre">myproject.reviews</span></code> comes <em>before</em>
<code class="docutils literal"><span class="pre">django.contrib.admin</span></code> in <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>, otherwise
<code class="docutils literal"><span class="pre">django.contrib.admin</span></code>’s will be loaded first and yours will be ignored.</p>
<p>Note that the loader performs an optimization when it first runs:
it caches a list of which <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code> packages have a
<code class="docutils literal"><span class="pre">templates</span></code> subdirectory.</p>
<p>You can enable this loader simply by setting
<code class="docutils literal"><span class="pre">APP_DIRS</span></code> to <code class="docutils literal"><span class="pre">True</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[{</span>
    <span class="s">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
    <span class="s">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">}]</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="other-loaders">
<h4>Other loaders<a class="headerlink" href="#other-loaders" title="Permalink to this headline">¶</a></h4>
<p>The remaining template loaders are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">django.template.loaders.eggs.Loader</span></code></li>
<li><code class="docutils literal"><span class="pre">django.template.loaders.cached.Loader</span></code></li>
<li><code class="docutils literal"><span class="pre">django.template.loaders.locmem.Loader</span></code></li>
</ul>
<p>These loaders are disabled by default, but you can activate them
by adding a <code class="docutils literal"><span class="pre">'loaders'</span></code> option to your <code class="docutils literal"><span class="pre">DjangoTemplates</span></code> backend in the
<code class="docutils literal"><span class="pre">TEMPLATES</span></code> setting or passing a <code class="docutils literal"><span class="pre">loaders</span></code> argument to
<code class="xref py py-class docutils literal"><span class="pre">Engine</span></code>. Details on these advanced loaders, as well as building your own
custom loader, can be found on the Django Project website.</p>
</div>
</div>
</div>
<div class="section" id="extending-the-template-system">
<h2>Extending the Template System<a class="headerlink" href="#extending-the-template-system" title="Permalink to this headline">¶</a></h2>
<p>Now that you understand a bit more about the internals of the template system,
let&#8217;s look at how to extend the system with custom code.</p>
<p>Most template customization comes in the form of custom template tags and/or
filters. Although the Django template language comes with many built-in tags and
filters, you&#8217;ll probably assemble your own libraries of tags and filters that
fit your own needs. Fortunately, it&#8217;s quite easy to define your own
functionality.</p>
<div class="section" id="code-layout">
<h3>Code layout<a class="headerlink" href="#code-layout" title="Permalink to this headline">¶</a></h3>
<p>Custom template tags and filters must live inside a Django app. If they relate
to an existing app it makes sense to bundle them there; otherwise, you should
create a new app to hold them.</p>
<p>The app should contain a <code class="docutils literal"><span class="pre">templatetags</span></code> directory, at the same level as
<code class="docutils literal"><span class="pre">models.py</span></code>, <code class="docutils literal"><span class="pre">views.py</span></code>, etc. If this doesn&#8217;t already exist, create it -
don&#8217;t forget the <code class="docutils literal"><span class="pre">__init__.py</span></code> file to ensure the directory is treated as a
Python package. After adding this module, you will need to restart your server
before you can use the tags or filters in templates.</p>
<p>Your custom tags and filters will live in a module inside the <code class="docutils literal"><span class="pre">templatetags</span></code>
directory. The name of the module file is the name you&#8217;ll use to load the tags
later, so be careful to pick a name that won&#8217;t clash with custom tags and
filters in another app.</p>
<p>For example, if your custom tags/filters are in a file called
<code class="docutils literal"><span class="pre">review_extras.py</span></code>, your app layout might look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>reviews/
    __init__.py
    models.py
    templatetags/
        __init__.py
        review_extras.py
    views.py
</pre></div>
</div>
<p>And in your template you would use the following:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">load</span> <span class="nv">review_extras</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>The app that contains the custom tags must be in <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code> in
order for the <code class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}&lt;load&gt;</span></code> tag to work. This is a security feature:
It allows you to host Python code for many template libraries on a single host
machine without enabling access to all of them for every Django installation.</p>
<p>There&#8217;s no limit on how many modules you put in the <code class="docutils literal"><span class="pre">templatetags</span></code> package.
Just keep in mind that a <code class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}&lt;load&gt;</span></code> statement will load
tags/filters for the given Python module name, not the name of the app.</p>
<p>To be a valid tag library, the module must contain a module-level variable
named <code class="docutils literal"><span class="pre">register</span></code> that is a <code class="docutils literal"><span class="pre">template.Library</span></code> instance, in which all the
tags and filters are registered. So, near the top of your module, put the
following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition-behind-the-scenes admonition">
<p class="first admonition-title">Behind the scenes</p>
<p>For a ton of examples, read the source code for Django&#8217;s default filters
and tags. They&#8217;re in <code class="docutils literal"><span class="pre">django/template/defaultfilters.py</span></code> and
<code class="docutils literal"><span class="pre">django/template/defaulttags.py</span></code>, respectively.</p>
<p class="last">For more information on the <code class="docutils literal"><span class="pre">load</span></code> tag, read its documentation.</p>
</div>
</div>
<div class="section" id="creating-a-template-library">
<h3>Creating a Template Library<a class="headerlink" href="#creating-a-template-library" title="Permalink to this headline">¶</a></h3>
<p>Whether you&#8217;re writing custom tags or filters, the first thing to do is to
create a <strong>template library</strong> &#8211; a small bit of infrastructure Django can hook
into.</p>
<p>Creating a template library is a two-step process:</p>
<ul>
<li><p class="first">First, decide which Django application should house the template library.
If you&#8217;ve created an app via <code class="docutils literal"><span class="pre">manage.py</span> <span class="pre">startapp</span></code>, you can put it in
there, or you can create another app solely for the template library.
We&#8217;d recommend the latter, because your filters might be useful to you
in future projects.</p>
<p>Whichever route you take, make sure to add the app to your
<code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code> setting. We&#8217;ll explain this shortly.</p>
</li>
<li><p class="first">Second, create a <code class="docutils literal"><span class="pre">templatetags</span></code> directory in the appropriate Django
application&#8217;s package. It should be on the same level as <code class="docutils literal"><span class="pre">models.py</span></code>,
<code class="docutils literal"><span class="pre">views.py</span></code>, and so forth. For example:</p>
<div class="highlight-python"><div class="highlight"><pre>books/
    __init__.py
    models.py
    templatetags/
    views.py
</pre></div>
</div>
<p>Create two empty files in the <code class="docutils literal"><span class="pre">templatetags</span></code> directory: an <code class="docutils literal"><span class="pre">__init__.py</span></code>
file (to indicate to Python that this is a package containing Python code)
and a file that will contain your custom tag/filter definitions. The name
of the latter file is what you&#8217;ll use to load the tags later. For example,
if your custom tags/filters are in a file called <code class="docutils literal"><span class="pre">review_extras.py</span></code>, you&#8217;d
write the following in a template:</p>
<div class="highlight-python"><div class="highlight"><pre>{% load review_extras %}
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}</span></code> tag looks at your <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code> setting and only
allows the loading of template libraries within installed Django
applications. This is a security feature; it allows you to host Python
code for many template libraries on a single computer without enabling
access to all of them for every Django installation.</p>
</li>
</ul>
<p>If you write a template library that isn&#8217;t tied to any particular models/views,
it&#8217;s valid and quite normal to have a Django application package that contains
only a <code class="docutils literal"><span class="pre">templatetags</span></code> package. There&#8217;s no limit on how many modules you put in
the <code class="docutils literal"><span class="pre">templatetags</span></code> package. Just keep in mind that a <code class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}</span></code> statement
will load tags/filters for the given Python module name, not the name of the
application.</p>
<p>Once you&#8217;ve created that Python module, you&#8217;ll just have to write a bit of
Python code, depending on whether you&#8217;re writing filters or tags.</p>
<p>To be a valid tag library, the module must contain a module-level variable named
<code class="docutils literal"><span class="pre">register</span></code> that is an instance of <code class="docutils literal"><span class="pre">template.Library</span></code>. This is the data
structure in which all the tags and filters are registered. So, near the top of
your module, insert the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For a fine selection of examples, read the source code for Django&#8217;s default
filters and tags. They&#8217;re in <code class="docutils literal"><span class="pre">django/template/defaultfilters.py</span></code> and
<code class="docutils literal"><span class="pre">django/template/defaulttags.py</span></code>, respectively. Some applications in
<code class="docutils literal"><span class="pre">django.contrib</span></code> also contain template libraries.</p>
</div>
<p>Once you&#8217;ve created this <code class="docutils literal"><span class="pre">register</span></code> variable, you&#8217;ll use it to create template
filters and tags.</p>
</div>
</div>
<div class="section" id="custom-template-tags-and-filters">
<h2>Custom template tags and filters<a class="headerlink" href="#custom-template-tags-and-filters" title="Permalink to this headline">¶</a></h2>
<p>Django&#8217;s template language comes with a wide variety of built-in
tags and filters designed to address the
presentation logic needs of your application. Nevertheless, you may
find yourself needing functionality that is not covered by the core
set of template primitives. You can extend the template engine by
defining custom tags and filters using Python, and then make them
available to your templates using the <code class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}&lt;load&gt;</span></code> tag.</p>
<div class="section" id="writing-custom-template-filters">
<span id="howto-writing-custom-template-filters"></span><h3>Writing Custom Template Filters<a class="headerlink" href="#writing-custom-template-filters" title="Permalink to this headline">¶</a></h3>
<p>Custom filters are just Python functions that take one or two arguments:</p>
<ul class="simple">
<li>The value of the variable (input) &#8211; not necessarily a string.</li>
<li>The value of the argument &#8211; this can have a default value, or be left
out altogether.</li>
</ul>
<p>For example, in the filter <code class="docutils literal"><span class="pre">{{</span> <span class="pre">var|foo:&quot;bar&quot;</span> <span class="pre">}}</span></code>, the filter <code class="docutils literal"><span class="pre">foo</span></code> would be
passed the variable <code class="docutils literal"><span class="pre">var</span></code> and the argument <code class="docutils literal"><span class="pre">&quot;bar&quot;</span></code>.</p>
<p>Since the template language doesn&#8217;t provide exception handling, any exception
raised from a template filter will be exposed as a server error. Thus, filter
functions should avoid raising exceptions if there is a reasonable fallback
value to return. In case of input that represents a clear bug in a template,
raising an exception may still be better than silent failure which hides the
bug.</p>
<p>Here&#8217;s an example filter definition:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes all values of arg from the given string&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And here&#8217;s an example of how that filter would be used:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">somevariable</span><span class="o">|</span><span class="nf">cut</span><span class="s2">:&quot;0&quot;</span> <span class="cp">}}</span>
</pre></div>
</div>
<p>Most filters don&#8217;t take arguments. In this case, just leave the argument out of
your function. Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="c"># Only one argument.</span>
    <span class="sd">&quot;&quot;&quot;Converts a string into all lowercase&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="registering-custom-filters">
<h3>Registering custom filters<a class="headerlink" href="#registering-custom-filters" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt id="django.template.Library.filter">
<code class="descclassname">django.template.Library.</code><code class="descname">filter</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#django.template.Library.filter" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Once you&#8217;ve written your filter definition, you need to register it with
your <code class="docutils literal"><span class="pre">Library</span></code> instance, to make it available to Django&#8217;s template language:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">register</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;cut&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">Library.filter()</span></code> method takes two arguments:</p>
<ol class="arabic simple">
<li>The name of the filter &#8211; a string.</li>
<li>The compilation function &#8211; a Python function (not the name of the
function as a string).</li>
</ol>
<p>You can use <code class="docutils literal"><span class="pre">register.filter()</span></code> as a decorator instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;cut&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="nd">@register.filter</span>
<span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
</div>
<p>If you leave off the <code class="docutils literal"><span class="pre">name</span></code> argument, as in the second example above, Django
will use the function&#8217;s name as the filter name.</p>
<p>Finally, <code class="docutils literal"><span class="pre">register.filter()</span></code> also accepts three keyword arguments,
<code class="docutils literal"><span class="pre">is_safe</span></code>, <code class="docutils literal"><span class="pre">needs_autoescape</span></code>, and <code class="docutils literal"><span class="pre">expects_localtime</span></code>. These arguments
are described in filters and auto-escaping and
filters and time zones below.</p>
</div>
<div class="section" id="template-filters-that-expect-strings">
<h3>Template filters that expect strings<a class="headerlink" href="#template-filters-that-expect-strings" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt id="django.template.defaultfilters.stringfilter">
<code class="descclassname">django.template.defaultfilters.</code><code class="descname">stringfilter</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#django.template.defaultfilters.stringfilter" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>If you&#8217;re writing a template filter that only expects a string as the first
argument, you should use the decorator <code class="docutils literal"><span class="pre">stringfilter</span></code>. This will
convert an object to its string value before being passed to your function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>
<span class="kn">from</span> <span class="nn">django.template.defaultfilters</span> <span class="kn">import</span> <span class="n">stringfilter</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>

<span class="nd">@register.filter</span>
<span class="nd">@stringfilter</span>
<span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
</div>
<p>This way, you&#8217;ll be able to pass, say, an integer to this filter, and it
won&#8217;t cause an <code class="docutils literal"><span class="pre">AttributeError</span></code> (because integers don&#8217;t have <code class="docutils literal"><span class="pre">lower()</span></code>
methods).</p>
</div>
<div class="section" id="filters-and-auto-escaping">
<span id="filters-auto-escaping"></span><h3>Filters and auto-escaping<a class="headerlink" href="#filters-and-auto-escaping" title="Permalink to this headline">¶</a></h3>
<p>When writing a custom filter, give some thought to how the filter will interact
with Django&#8217;s auto-escaping behavior. Note that three types of strings can be
passed around inside the template code:</p>
<ul>
<li><p class="first"><strong>Raw strings</strong> are the native Python <code class="docutils literal"><span class="pre">str</span></code> or <code class="docutils literal"><span class="pre">unicode</span></code> types. On
output, they&#8217;re escaped if auto-escaping is in effect and presented
unchanged, otherwise.</p>
</li>
<li><p class="first"><strong>Safe strings</strong> are strings that have been marked safe from further
escaping at output time. Any necessary escaping has already been done.
They&#8217;re commonly used for output that contains raw HTML that is intended
to be interpreted as-is on the client side.</p>
<p>Internally, these strings are of type <code class="docutils literal"><span class="pre">SafeBytes</span></code> or <code class="docutils literal"><span class="pre">SafeText</span></code>.
They share a common base class of <code class="docutils literal"><span class="pre">SafeData</span></code>, so you can test
for them using code like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SafeData</span><span class="p">):</span>
    <span class="c"># Do something with the &quot;safe&quot; string.</span>
    <span class="o">...</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>Strings marked as &#8220;needing escaping&#8221;</strong> are <em>always</em> escaped on
output, regardless of whether they are in an <code class="docutils literal"><span class="pre">autoescape</span></code> block or
not. These strings are only escaped once, however, even if auto-escaping
applies.</p>
<p>Internally, these strings are of type <code class="docutils literal"><span class="pre">EscapeBytes</span></code> or
<code class="docutils literal"><span class="pre">EscapeText</span></code>. Generally you don&#8217;t have to worry about these; they
exist for the implementation of the <code class="docutils literal"><span class="pre">escape</span></code> filter.</p>
</li>
</ul>
<p>Template filter code falls into one of two situations:</p>
<ol class="arabic">
<li><p class="first">Your filter does not introduce any HTML-unsafe characters (<code class="docutils literal"><span class="pre">&lt;</span></code>, <code class="docutils literal"><span class="pre">&gt;</span></code>,
<code class="docutils literal"><span class="pre">'</span></code>, <code class="docutils literal"><span class="pre">&quot;</span></code> or <code class="docutils literal"><span class="pre">&amp;</span></code>) into the result that were not already present. In
this case, you can let Django take care of all the auto-escaping
handling for you. All you need to do is set the <code class="docutils literal"><span class="pre">is_safe</span></code> flag to <code class="docutils literal"><span class="pre">True</span></code>
when you register your filter function, like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.filter</span><span class="p">(</span><span class="n">is_safe</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">myfilter</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
<p>This flag tells Django that if a &#8220;safe&#8221; string is passed into your
filter, the result will still be &#8220;safe&#8221; and if a non-safe string is
passed in, Django will automatically escape it, if necessary.</p>
<p>You can think of this as meaning &#8220;this filter is safe &#8211; it doesn&#8217;t
introduce any possibility of unsafe HTML.&#8221;</p>
<p>The reason <code class="docutils literal"><span class="pre">is_safe</span></code> is necessary is because there are plenty of
normal string operations that will turn a <code class="docutils literal"><span class="pre">SafeData</span></code> object back into
a normal <code class="docutils literal"><span class="pre">str</span></code> or <code class="docutils literal"><span class="pre">unicode</span></code> object and, rather than try to catch
them all, which would be very difficult, Django repairs the damage after
the filter has completed.</p>
<p>For example, suppose you have a filter that adds the string <code class="docutils literal"><span class="pre">xx</span></code> to
the end of any input. Since this introduces no dangerous HTML characters
to the result (aside from any that were already present), you should
mark your filter with <code class="docutils literal"><span class="pre">is_safe</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.filter</span><span class="p">(</span><span class="n">is_safe</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_xx</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">xx&#39;</span> <span class="o">%</span> <span class="n">value</span>
</pre></div>
</div>
<p>When this filter is used in a template where auto-escaping is enabled,
Django will escape the output whenever the input is not already marked
as &#8220;safe&#8221;.</p>
<p>By default, <code class="docutils literal"><span class="pre">is_safe</span></code> is <code class="docutils literal"><span class="pre">False</span></code>, and you can omit it from any filters
where it isn&#8217;t required.</p>
<p>Be careful when deciding if your filter really does leave safe strings
as safe. If you&#8217;re <em>removing</em> characters, you might inadvertently leave
unbalanced HTML tags or entities in the result. For example, removing a
<code class="docutils literal"><span class="pre">&gt;</span></code> from the input might turn <code class="docutils literal"><span class="pre">&lt;a&gt;</span></code> into <code class="docutils literal"><span class="pre">&lt;a</span></code>, which would need to
be escaped on output to avoid causing problems. Similarly, removing a
semicolon (<code class="docutils literal"><span class="pre">;</span></code>) can turn <code class="docutils literal"><span class="pre">&amp;amp;</span></code> into <code class="docutils literal"><span class="pre">&amp;amp</span></code>, which is no longer a
valid entity and thus needs further escaping. Most cases won&#8217;t be nearly
this tricky, but keep an eye out for any problems like that when
reviewing your code.</p>
<p>Marking a filter <code class="docutils literal"><span class="pre">is_safe</span></code> will coerce the filter&#8217;s return value to
a string.  If your filter should return a boolean or other non-string
value, marking it <code class="docutils literal"><span class="pre">is_safe</span></code> will probably have unintended
consequences (such as converting a boolean False to the string
&#8216;False&#8217;).</p>
</li>
<li><p class="first">Alternatively, your filter code can manually take care of any necessary
escaping. This is necessary when you&#8217;re introducing new HTML markup into
the result. You want to mark the output as safe from further
escaping so that your HTML markup isn&#8217;t escaped further, so you&#8217;ll need
to handle the input yourself.</p>
<p>To mark the output as a safe string, use
<code class="xref py py-func docutils literal"><span class="pre">django.utils.safestring.mark_safe()</span></code>.</p>
<p>Be careful, though. You need to do more than just mark the output as
safe. You need to ensure it really <em>is</em> safe, and what you do depends on
whether auto-escaping is in effect. The idea is to write filters than
can operate in templates where auto-escaping is either on or off in
order to make things easier for your template authors.</p>
<p>In order for your filter to know the current auto-escaping state, set the
<code class="docutils literal"><span class="pre">needs_autoescape</span></code> flag to <code class="docutils literal"><span class="pre">True</span></code> when you register your filter function.
(If you don&#8217;t specify this flag, it defaults to <code class="docutils literal"><span class="pre">False</span></code>). This flag tells
Django that your filter function wants to be passed an extra keyword
argument, called <code class="docutils literal"><span class="pre">autoescape</span></code>, that is <code class="docutils literal"><span class="pre">True</span></code> if auto-escaping is in
effect and <code class="docutils literal"><span class="pre">False</span></code> otherwise.</p>
<p>For example, let&#8217;s write a filter that emphasizes the first character of
a string:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>
<span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="kn">import</span> <span class="n">conditional_escape</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>

<span class="nd">@register.filter</span><span class="p">(</span><span class="n">needs_autoescape</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">initial_letter_filter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">autoescape</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">first</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">autoescape</span><span class="p">:</span>
        <span class="n">esc</span> <span class="o">=</span> <span class="n">conditional_escape</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">esc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&lt;strong&gt;</span><span class="si">%s</span><span class="s">&lt;/strong&gt;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">esc</span><span class="p">(</span><span class="n">first</span><span class="p">),</span> <span class="n">esc</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mark_safe</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">needs_autoescape</span></code> flag and the <code class="docutils literal"><span class="pre">autoescape</span></code> keyword argument mean
that our function will know whether automatic escaping is in effect when the
filter is called. We use <code class="docutils literal"><span class="pre">autoescape</span></code> to decide whether the input data
needs to be passed through <code class="docutils literal"><span class="pre">django.utils.html.conditional_escape</span></code> or not.
(In the latter case, we just use the identity function as the &#8220;escape&#8221;
function.) The <code class="docutils literal"><span class="pre">conditional_escape()</span></code> function is like <code class="docutils literal"><span class="pre">escape()</span></code> except
it only escapes input that is <strong>not</strong> a <code class="docutils literal"><span class="pre">SafeData</span></code> instance. If a
<code class="docutils literal"><span class="pre">SafeData</span></code> instance is passed to <code class="docutils literal"><span class="pre">conditional_escape()</span></code>, the data is
returned unchanged.</p>
<p>Finally, in the above example, we remember to mark the result as safe
so that our HTML is inserted directly into the template without further
escaping.</p>
<p>There&#8217;s no need to worry about the <code class="docutils literal"><span class="pre">is_safe</span></code> flag in this case
(although including it wouldn&#8217;t hurt anything). Whenever you manually
handle the auto-escaping issues and return a safe string, the
<code class="docutils literal"><span class="pre">is_safe</span></code> flag won&#8217;t change anything either way.</p>
</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Avoiding XSS vulnerabilities when reusing built-in filters</p>
<p>Be careful when reusing Django&#8217;s built-in filters. You&#8217;ll need to pass
<code class="docutils literal"><span class="pre">autoescape=True</span></code> to the filter in order to get the proper autoescaping
behavior and avoid a cross-site script vulnerability.</p>
<p>For example, if you wanted to write a custom filter called
<code class="docutils literal"><span class="pre">urlize_and_linebreaks</span></code> that combined the <code class="docutils literal"><span class="pre">urlize</span></code> and
<code class="docutils literal"><span class="pre">linebreaksbr</span></code> filters, the filter would look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.template.defaultfilters</span> <span class="kn">import</span> <span class="n">linebreaksbr</span><span class="p">,</span> <span class="n">urlize</span>

<span class="nd">@register.filter</span>
<span class="k">def</span> <span class="nf">urlize_and_linebreaks</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">linebreaksbr</span><span class="p">(</span><span class="n">urlize</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">autoescape</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">autoescape</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Then:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">comment</span><span class="o">|</span><span class="nf">urlize_and_linebreaks</span> <span class="cp">}}</span>
</pre></div>
</div>
<p>would be equivalent to:</p>
<div class="last highlight-html+django"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">comment</span><span class="o">|</span><span class="nf">urlize</span><span class="o">|</span><span class="nf">linebreaksbr</span> <span class="cp">}}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="filters-and-time-zones">
<span id="filters-timezones"></span><h3>Filters and time zones<a class="headerlink" href="#filters-and-time-zones" title="Permalink to this headline">¶</a></h3>
<p>If you write a custom filter that operates on <code class="xref py py-class docutils literal"><span class="pre">datetime</span></code>
objects, you&#8217;ll usually register it with the <code class="docutils literal"><span class="pre">expects_localtime</span></code> flag set to
<code class="docutils literal"><span class="pre">True</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.filter</span><span class="p">(</span><span class="n">expects_localtime</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">businesshours</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">9</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">17</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
</pre></div>
</div>
<p>When this flag is set, if the first argument to your filter is a time zone
aware datetime, Django will convert it to the current time zone before passing
it to your filter when appropriate, according to rules for time zones
conversions in templates.</p>
</div>
<div class="section" id="writing-custom-template-tags">
<h3>Writing custom template tags<a class="headerlink" href="#writing-custom-template-tags" title="Permalink to this headline">¶</a></h3>
<p>Tags are more complex than filters, because tags can do anything. Django
provides a number of shortcuts that make writing most types of tags easier.
First we&#8217;ll explore those shortcuts, then explain how to write a tag from
scratch for those cases when the shortcuts aren&#8217;t powerful enough.</p>
</div>
<div class="section" id="simple-tags">
<span id="howto-custom-template-tags-simple-tags"></span><h3>Simple tags<a class="headerlink" href="#simple-tags" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt id="django.template.Library.simple_tag">
<code class="descclassname">django.template.Library.</code><code class="descname">simple_tag</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#django.template.Library.simple_tag" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Many template tags take a number of arguments &#8211; strings or template variables
&#8211; and return a result after doing some processing based solely on
the input arguments and some external information. For example, a
<code class="docutils literal"><span class="pre">current_time</span></code> tag might accept a format string and return the time as a
string formatted accordingly.</p>
<p>To ease the creation of these types of tags, Django provides a helper function,
<code class="docutils literal"><span class="pre">simple_tag</span></code>. This function, which is a method of
<code class="docutils literal"><span class="pre">django.template.Library</span></code>, takes a function that accepts any number of
arguments, wraps it in a <code class="docutils literal"><span class="pre">render</span></code> function and the other necessary bits
mentioned above and registers it with the template system.</p>
<p>Our <code class="docutils literal"><span class="pre">current_time</span></code> function could thus be written like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>

<span class="nd">@register.simple_tag</span>
<span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="n">format_string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format_string</span><span class="p">)</span>
</pre></div>
</div>
<p>A few things to note about the <code class="docutils literal"><span class="pre">simple_tag</span></code> helper function:</p>
<ul class="simple">
<li>Checking for the required number of arguments, etc., has already been
done by the time our function is called, so we don&#8217;t need to do that.</li>
<li>The quotes around the argument (if any) have already been stripped away,
so we just receive a plain string.</li>
<li>If the argument was a template variable, our function is passed the
current value of the variable, not the variable itself.</li>
</ul>
<p>If your template tag needs to access the current context, you can use the
<code class="docutils literal"><span class="pre">takes_context</span></code> argument when registering your tag:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.simple_tag</span><span class="p">(</span><span class="n">takes_context</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">format_string</span><span class="p">):</span>
    <span class="n">timezone</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;timezone&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">your_get_current_time_method</span><span class="p">(</span><span class="n">timezone</span><span class="p">,</span> <span class="n">format_string</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the first argument <em>must</em> be called <code class="docutils literal"><span class="pre">context</span></code>.</p>
<p>For more information on how the <code class="docutils literal"><span class="pre">takes_context</span></code> option works, see the section
on inclusion tags.</p>
<p>If you need to rename your tag, you can provide a custom name for it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">register</span><span class="o">.</span><span class="n">simple_tag</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;minusone&#39;</span><span class="p">)</span>

<span class="nd">@register.simple_tag</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;minustwo&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">some_function</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">-</span> <span class="mi">2</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">simple_tag</span></code> functions may accept any number of positional or keyword
arguments. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.simple_tag</span>
<span class="k">def</span> <span class="nf">my_tag</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">warning</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;warning&#39;</span><span class="p">]</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;profile&#39;</span><span class="p">]</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="o">...</span>
</pre></div>
</div>
<p>Then in the template any number of arguments, separated by spaces, may be
passed to the template tag. Like in Python, the values for keyword arguments
are set using the equal sign (&#8220;<code class="docutils literal"><span class="pre">=</span></code>&#8221;) and must be provided after the
positional arguments. For example:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">my_tag</span> <span class="m">123</span> <span class="s2">&quot;abcd&quot;</span> <span class="nv">book.title</span> <span class="nv">warning</span><span class="o">=</span><span class="nv">message</span><span class="o">|</span><span class="nf">lower</span> <span class="nv">profile</span><span class="o">=</span><span class="nv">user.profile</span> <span class="cp">%}</span>
</pre></div>
</div>
</div>
<div class="section" id="inclusion-tags">
<span id="howto-custom-template-tags-inclusion-tags"></span><h3>Inclusion tags<a class="headerlink" href="#inclusion-tags" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt id="django.template.Library.inclusion_tag">
<code class="descclassname">django.template.Library.</code><code class="descname">inclusion_tag</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#django.template.Library.inclusion_tag" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Another common type of template tag is the type that displays some data by
rendering <em>another</em> template. For example, Django&#8217;s admin interface uses custom
template tags to display the buttons along the bottom of the &#8220;add/change&#8221; form
pages. Those buttons always look the same, but the link targets change
depending on the object being edited &#8211; so they&#8217;re a perfect case for using a
small template that is filled with details from the current object. (In the
admin&#8217;s case, this is the <code class="docutils literal"><span class="pre">submit_row</span></code> tag.)</p>
<p>These sorts of tags are called <em>inclusion tags</em>. Writing inclusion tags is
probably best demonstrated by example. Let&#8217;s write a tag that produces a list
of books for a given <code class="docutils literal"><span class="pre">Author</span></code> object. We&#8217;ll use the tag like this:</p>
<div class="highlight-python"><div class="highlight"><pre>{% books_for_author author %}
</pre></div>
</div>
<p>The result will be something like this:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;ul&gt;
    &lt;li&gt;The Cat In The Hat&lt;/li&gt;
    &lt;li&gt;Hop On Pop&lt;/li&gt;
    &lt;li&gt;Green Eggs And Ham&lt;/li&gt;
&lt;/ul&gt;
</pre></div>
</div>
<p>First, we define the function that takes the argument and produces a
dictionary of data for the result. Notice that we need to return only a
dictionary, not anything more complex. This will be used as the context for
the template fragment:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">books_for_author</span><span class="p">(</span><span class="n">author</span><span class="p">):</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__id</span><span class="o">=</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;books&#39;</span><span class="p">:</span> <span class="n">books</span><span class="p">}</span>
</pre></div>
</div>
<p>Next, we create the template used to render the tag&#8217;s output. Following our
example, the template is very simple:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;ul&gt;
{% for book in books %}
    &lt;li&gt;{{ book.title }}&lt;/li&gt;
{% endfor %}
&lt;/ul&gt;
</pre></div>
</div>
<p>Finally, we create and register the inclusion tag by calling the
<code class="docutils literal"><span class="pre">inclusion_tag()</span></code> method on a <code class="docutils literal"><span class="pre">Library</span></code> object.</p>
<p>Following our example, if the preceding template is in a file called
<code class="docutils literal"><span class="pre">book_snippet.html</span></code> in a directory that&#8217;s searched by the template loader,
we register the tag like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Here, register is a django.template.Library instance, as before</span>
<span class="nd">@register.inclusion_tag</span><span class="p">(</span><span class="s">&#39;book_snippet.html&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_reviews</span><span class="p">(</span><span class="n">review</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Alternatively it is possible to register the inclusion tag using a
<code class="xref py py-class docutils literal"><span class="pre">django.template.Template</span></code> instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">get_template</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="s">&#39;book_snippet.html&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">inclusion_tag</span><span class="p">(</span><span class="n">t</span><span class="p">)(</span><span class="n">show_reviews</span><span class="p">)</span>
</pre></div>
</div>
<p>...when first creating the function.</p>
<p>Sometimes, your inclusion tags might require a large number of arguments,
making it a pain for template authors to pass in all the arguments and remember
their order. To solve this, Django provides a <code class="docutils literal"><span class="pre">takes_context</span></code> option for
inclusion tags. If you specify <code class="docutils literal"><span class="pre">takes_context</span></code> in creating an inclusion tag,
the tag will have no required arguments, and the underlying Python function
will have one argument: the template context as of when the tag was called.</p>
<p>For example, say you&#8217;re writing an inclusion tag that will always be used in a
context that contains <code class="docutils literal"><span class="pre">home_link</span></code> and <code class="docutils literal"><span class="pre">home_title</span></code> variables that point
back to the main page. Here&#8217;s what the Python function would look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.inclusion_tag</span><span class="p">(</span><span class="s">&#39;link.html&#39;</span><span class="p">,</span> <span class="n">takes_context</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">jump_link</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;link&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;home_link&#39;</span><span class="p">],</span>
        <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;home_title&#39;</span><span class="p">],</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>(Note that the first parameter to the function <em>must</em> be called <code class="docutils literal"><span class="pre">context</span></code>.)</p>
<p>The template <code class="docutils literal"><span class="pre">link.html</span></code> might contain the following:</p>
<div class="highlight-python"><div class="highlight"><pre>Jump directly to &lt;a href=&quot;{{ link }}&quot;&gt;{{ title }}&lt;/a&gt;.
</pre></div>
</div>
<p>Then, anytime you want to use that custom tag, load its library and call it
without any arguments, like so:</p>
<div class="highlight-python"><div class="highlight"><pre>{% jump_link %}
</pre></div>
</div>
<p>Note that when you&#8217;re using <code class="docutils literal"><span class="pre">takes_context=True</span></code>, there&#8217;s no need to pass
arguments to the template tag. It automatically gets access to the context.</p>
<p>The <code class="docutils literal"><span class="pre">takes_context</span></code> parameter defaults to <code class="docutils literal"><span class="pre">False</span></code>. When it&#8217;s set to
<code class="docutils literal"><span class="pre">True</span></code>, the tag is passed the context object, as in this example. That&#8217;s the
only difference between this case and the previous <code class="docutils literal"><span class="pre">inclusion_tag</span></code> example.</p>
<p><code class="docutils literal"><span class="pre">inclusion_tag</span></code> functions may accept any number of positional or keyword
arguments. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.inclusion_tag</span><span class="p">(</span><span class="s">&#39;my_template.html&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_tag</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">warning</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;warning&#39;</span><span class="p">]</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;profile&#39;</span><span class="p">]</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="o">...</span>
</pre></div>
</div>
<p>Then in the template any number of arguments, separated by spaces, may be
passed to the template tag. Like in Python, the values for keyword arguments
are set using the equal sign (&#8220;<code class="docutils literal"><span class="pre">=</span></code>&#8221;) and must be provided after the
positional arguments. For example:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">my_tag</span> <span class="m">123</span> <span class="s2">&quot;abcd&quot;</span> <span class="nv">book.title</span> <span class="nv">warning</span><span class="o">=</span><span class="nv">message</span><span class="o">|</span><span class="nf">lower</span> <span class="nv">profile</span><span class="o">=</span><span class="nv">user.profile</span> <span class="cp">%}</span>
</pre></div>
</div>
</div>
<div class="section" id="assignment-tags">
<h3>Assignment tags<a class="headerlink" href="#assignment-tags" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt id="django.template.Library.assignment_tag">
<code class="descclassname">django.template.Library.</code><code class="descname">assignment_tag</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#django.template.Library.assignment_tag" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>To ease the creation of tags setting a variable in the context, Django provides
a helper function, <code class="docutils literal"><span class="pre">assignment_tag</span></code>. This function works the same way as
<a class="reference internal" href="#django.template.Library.simple_tag" title="django.template.Library.simple_tag"><code class="xref py py-meth docutils literal"><span class="pre">simple_tag()</span></code></a> except that it stores the tag&#8217;s
result in a specified context variable instead of directly outputting it.</p>
<p>Our earlier <code class="docutils literal"><span class="pre">current_time</span></code> function could thus be written like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.assignment_tag</span>
<span class="k">def</span> <span class="nf">get_current_time</span><span class="p">(</span><span class="n">format_string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format_string</span><span class="p">)</span>
</pre></div>
</div>
<p>You may then store the result in a template variable using the <code class="docutils literal"><span class="pre">as</span></code> argument
followed by the variable name, and output it yourself where you see fit:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">get_current_time</span> <span class="s2">&quot;%Y-%m-%d %I:%M %p&quot;</span> <span class="k">as</span> <span class="nv">the_time</span> <span class="cp">%}</span>
<span class="nt">&lt;p&gt;</span>The time is <span class="cp">{{</span> <span class="nv">the_time</span> <span class="cp">}}</span>.<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="advanced-custom-template-tags">
<h3>Advanced custom template tags<a class="headerlink" href="#advanced-custom-template-tags" title="Permalink to this headline">¶</a></h3>
<p>Sometimes the basic features for custom template tag creation aren&#8217;t enough.
Don&#8217;t worry, Django gives you complete access to the internals required to build
a template tag from the ground up.</p>
</div>
<div class="section" id="a-quick-overview">
<h3>A quick overview<a class="headerlink" href="#a-quick-overview" title="Permalink to this headline">¶</a></h3>
<p>The template system works in a two-step process: compiling and rendering. To
define a custom template tag, you specify how the compilation works and how
the rendering works.</p>
<p>When Django compiles a template, it splits the raw template text into
&#8216;&#8217;nodes&#8217;&#8216;. Each node is an instance of <code class="docutils literal"><span class="pre">django.template.Node</span></code> and has
a <code class="docutils literal"><span class="pre">render()</span></code> method. A compiled template is, simply, a list of <code class="docutils literal"><span class="pre">Node</span></code>
objects. When you call <code class="docutils literal"><span class="pre">render()</span></code> on a compiled template object, the template
calls <code class="docutils literal"><span class="pre">render()</span></code> on each <code class="docutils literal"><span class="pre">Node</span></code> in its node list, with the given context.
The results are all concatenated together to form the output of the template.</p>
<p>Thus, to define a custom template tag, you specify how the raw template tag is
converted into a <code class="docutils literal"><span class="pre">Node</span></code> (the compilation function), and what the node&#8217;s
<code class="docutils literal"><span class="pre">render()</span></code> method does.</p>
</div>
<div class="section" id="writing-the-compilation-function">
<h3>Writing the compilation function<a class="headerlink" href="#writing-the-compilation-function" title="Permalink to this headline">¶</a></h3>
<p>For each template tag the template parser encounters, it calls a Python
function with the tag contents and the parser object itself. This function is
responsible for returning a <code class="docutils literal"><span class="pre">Node</span></code> instance based on the contents of the tag.</p>
<p>For example, let&#8217;s write a full implementation of our simple template tag,
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">current_time</span> <span class="pre">%}</span></code>, that displays the current date/time, formatted according
to a parameter given in the tag, in <code class="xref py py-func docutils literal"><span class="pre">strftime()</span></code> syntax. It&#8217;s a good
idea to decide the tag syntax before anything else. In our case, let&#8217;s say the
tag should be used like this:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="nt">&lt;p&gt;</span>The time is <span class="cp">{%</span> <span class="k">current_time</span> <span class="s2">&quot;%Y-%m-%d %I:%M %p&quot;</span> <span class="cp">%}</span>.<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>The parser for this function should grab the parameter and create a <code class="docutils literal"><span class="pre">Node</span></code>
object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="k">def</span> <span class="nf">do_current_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># split_contents() knows not to split quoted strings.</span>
        <span class="n">tag_name</span><span class="p">,</span> <span class="n">format_string</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split_contents</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag requires a single argument&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">format_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag&#39;s argument should be in quotes&quot;</span> <span class="o">%</span> <span class="n">tag_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CurrentTimeNode</span><span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>Notes:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">parser</span></code> is the template parser object. We don&#8217;t need it in this
example.</li>
<li><code class="docutils literal"><span class="pre">token.contents</span></code> is a string of the raw contents of the tag. In our
example, it&#8217;s <code class="docutils literal"><span class="pre">'current_time</span> <span class="pre">&quot;%Y-%m-%d</span> <span class="pre">%I:%M</span> <span class="pre">%p&quot;'</span></code>.</li>
<li>The <code class="docutils literal"><span class="pre">token.split_contents()</span></code> method separates the arguments on spaces
while keeping quoted strings together. The more straightforward
<code class="docutils literal"><span class="pre">token.contents.split()</span></code> wouldn&#8217;t be as robust, as it would naively
split on <em>all</em> spaces, including those within quoted strings. It&#8217;s a good
idea to always use <code class="docutils literal"><span class="pre">token.split_contents()</span></code>.</li>
<li>This function is responsible for raising
<code class="docutils literal"><span class="pre">django.template.TemplateSyntaxError</span></code>, with helpful messages, for
any syntax error.</li>
<li>The <code class="docutils literal"><span class="pre">TemplateSyntaxError</span></code> exceptions use the <code class="docutils literal"><span class="pre">tag_name</span></code> variable.
Don&#8217;t hard-code the tag&#8217;s name in your error messages, because that
couples the tag&#8217;s name to your function. <code class="docutils literal"><span class="pre">token.contents.split()[0]</span></code>
will &#8216;&#8217;always&#8217;&#8217; be the name of your tag &#8211; even when the tag has no
arguments.</li>
<li>The function returns a <code class="docutils literal"><span class="pre">CurrentTimeNode</span></code> with everything the node needs
to know about this tag. In this case, it just passes the argument &#8211;
<code class="docutils literal"><span class="pre">&quot;%Y-%m-%d</span> <span class="pre">%I:%M</span> <span class="pre">%p&quot;</span></code>. The leading and trailing quotes from the
template tag are removed in <code class="docutils literal"><span class="pre">format_string[1:-1]</span></code>.</li>
<li>The parsing is very low-level. The Django developers have experimented
with writing small frameworks on top of this parsing system, using
techniques such as EBNF grammars, but those experiments made the template
engine too slow. It&#8217;s low-level because that&#8217;s fastest.</li>
</ul>
</div>
<div class="section" id="writing-the-renderer">
<h3>Writing the renderer<a class="headerlink" href="#writing-the-renderer" title="Permalink to this headline">¶</a></h3>
<p>The second step in writing custom tags is to define a <code class="docutils literal"><span class="pre">Node</span></code> subclass that
has a <code class="docutils literal"><span class="pre">render()</span></code> method.</p>
<p>Continuing the above example, we need to define <code class="docutils literal"><span class="pre">CurrentTimeNode</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="k">class</span> <span class="nc">CurrentTimeNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="n">format_string</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
</pre></div>
</div>
<p>Notes:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">__init__()</span></code> gets the <code class="docutils literal"><span class="pre">format_string</span></code> from <code class="docutils literal"><span class="pre">do_current_time()</span></code>.
Always pass any options/parameters/arguments to a <code class="docutils literal"><span class="pre">Node</span></code> via its
<code class="docutils literal"><span class="pre">__init__()</span></code>.</li>
<li>The <code class="docutils literal"><span class="pre">render()</span></code> method is where the work actually happens.</li>
<li><code class="docutils literal"><span class="pre">render()</span></code> should generally fail silently, particularly in a production
environment where <code class="docutils literal"><span class="pre">DEBUG</span></code> and <code class="docutils literal"><span class="pre">TEMPLATE_DEBUG</span></code> are
<code class="docutils literal"><span class="pre">False</span></code>. In some cases however, particularly if <code class="docutils literal"><span class="pre">TEMPLATE_DEBUG</span></code> is
<code class="docutils literal"><span class="pre">True</span></code>, this method may raise an exception to make debugging easier. For
example, several core tags raise <code class="docutils literal"><span class="pre">django.template.TemplateSyntaxError</span></code>
if they receive the wrong number or type of arguments.</li>
</ul>
<p>Ultimately, this decoupling of compilation and rendering results in an
efficient template system, because a template can render multiple contexts
without having to be parsed multiple times.</p>
</div>
<div class="section" id="auto-escaping-considerations">
<h3>Auto-escaping considerations<a class="headerlink" href="#auto-escaping-considerations" title="Permalink to this headline">¶</a></h3>
<p>The output from template tags is <strong>not</strong> automatically run through the
auto-escaping filters. However, there are still a couple of things you should
keep in mind when writing a template tag.</p>
<p>If the <code class="docutils literal"><span class="pre">render()</span></code> function of your template stores the result in a context
variable (rather than returning the result in a string), it should take care
to call <code class="docutils literal"><span class="pre">mark_safe()</span></code> if appropriate. When the variable is ultimately
rendered, it will be affected by the auto-escape setting in effect at the
time, so content that should be safe from further escaping needs to be marked
as such.</p>
<p>Also, if your template tag creates a new context for performing some
sub-rendering, set the auto-escape attribute to the current context&#8217;s value.
The <code class="docutils literal"><span class="pre">__init__</span></code> method for the <code class="docutils literal"><span class="pre">Context</span></code> class takes a parameter called
<code class="docutils literal"><span class="pre">autoescape</span></code> that you can use for this purpose. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">Context</span>

<span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">new_context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span><span class="s">&#39;var&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">},</span> <span class="n">autoescape</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">autoescape</span><span class="p">)</span>
    <span class="c"># ... Do something with new_context ...</span>
</pre></div>
</div>
<p>This is not a very common situation, but it&#8217;s useful if you&#8217;re rendering a
template yourself. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;small_fragment.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">Context</span><span class="p">({</span><span class="s">&#39;var&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">},</span> <span class="n">autoescape</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">autoescape</span><span class="p">))</span>
</pre></div>
</div>
<p>If we had neglected to pass in the current <code class="docutils literal"><span class="pre">context.autoescape</span></code> value to our
new <code class="docutils literal"><span class="pre">Context</span></code> in this example, the results would have <em>always</em> been
automatically escaped, which may not be the desired behavior if the template
tag is used inside a <code class="docutils literal"><span class="pre">{%</span> <span class="pre">autoescape</span> <span class="pre">off</span> <span class="pre">%}&lt;autoescape&gt;</span></code> block.</p>
</div>
<div class="section" id="thread-safety-considerations">
<span id="template-tag-thread-safety"></span><h3>Thread-safety considerations<a class="headerlink" href="#thread-safety-considerations" title="Permalink to this headline">¶</a></h3>
<p>Once a node is parsed, its <code class="docutils literal"><span class="pre">render</span></code> method may be called any number of times.
Since Django is sometimes run in multi-threaded environments, a single node may
be simultaneously rendering with different contexts in response to two separate
requests. Therefore, it&#8217;s important to make sure your template tags are thread
safe.</p>
<p>To make sure your template tags are thread safe, you should never store state
information on the node itself. For example, Django provides a builtin
<code class="docutils literal"><span class="pre">cycle</span></code> template tag that cycles among a list of given strings each time
it&#8217;s rendered:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">for</span> <span class="nv">o</span> <span class="k">in</span> <span class="nv">some_list</span> <span class="cp">%}</span>
    <span class="nt">&lt;tr</span> <span class="na">class=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">cycle</span> <span class="s1">&#39;row1&#39;</span> <span class="s1">&#39;row2&#39;</span> <span class="cp">%}</span><span class="nt">&gt;</span>
        ...
    <span class="nt">&lt;/tr&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>A naive implementation of <code class="docutils literal"><span class="pre">CycleNode</span></code> might look something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="k">class</span> <span class="nc">CycleNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cyclevars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle_iter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">cyclevars</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle_iter</span><span class="p">)</span>
</pre></div>
</div>
<p>But, suppose we have two templates rendering the template snippet from above at
the same time:</p>
<ol class="arabic simple">
<li>Thread 1 performs its first loop iteration, <code class="docutils literal"><span class="pre">CycleNode.render()</span></code>
returns &#8216;row1&#8217;</li>
<li>Thread 2 performs its first loop iteration, <code class="docutils literal"><span class="pre">CycleNode.render()</span></code>
returns &#8216;row2&#8217;</li>
<li>Thread 1 performs its second loop iteration, <code class="docutils literal"><span class="pre">CycleNode.render()</span></code>
returns &#8216;row1&#8217;</li>
<li>Thread 2 performs its second loop iteration, <code class="docutils literal"><span class="pre">CycleNode.render()</span></code>
returns &#8216;row2&#8217;</li>
</ol>
<p>The CycleNode is iterating, but it&#8217;s iterating globally. As far as Thread 1
and Thread 2 are concerned, it&#8217;s always returning the same value. This is
obviously not what we want!</p>
<p>To address this problem, Django provides a <code class="docutils literal"><span class="pre">render_context</span></code> that&#8217;s associated
with the <code class="docutils literal"><span class="pre">context</span></code> of the template that is currently being rendered. The
<code class="docutils literal"><span class="pre">render_context</span></code> behaves like a Python dictionary, and should be used to
store <code class="docutils literal"><span class="pre">Node</span></code> state between invocations of the <code class="docutils literal"><span class="pre">render</span></code> method.</p>
<p>Let&#8217;s refactor our <code class="docutils literal"><span class="pre">CycleNode</span></code> implementation to use the <code class="docutils literal"><span class="pre">render_context</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CycleNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cyclevars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cyclevars</span> <span class="o">=</span> <span class="n">cyclevars</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">render_context</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">render_context</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cyclevars</span><span class="p">)</span>
        <span class="n">cycle_iter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">render_context</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">cycle_iter</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that it&#8217;s perfectly safe to store global information that will not change
throughout the life of the <code class="docutils literal"><span class="pre">Node</span></code> as an attribute. In the case of
<code class="docutils literal"><span class="pre">CycleNode</span></code>, the <code class="docutils literal"><span class="pre">cyclevars</span></code> argument doesn&#8217;t change after the <code class="docutils literal"><span class="pre">Node</span></code> is
instantiated, so we don&#8217;t need to put it in the <code class="docutils literal"><span class="pre">render_context</span></code>. But state
information that is specific to the template that is currently being rendered,
like the current iteration of the <code class="docutils literal"><span class="pre">CycleNode</span></code>, should be stored in the
<code class="docutils literal"><span class="pre">render_context</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Notice how we used <code class="docutils literal"><span class="pre">self</span></code> to scope the <code class="docutils literal"><span class="pre">CycleNode</span></code> specific information
within the <code class="docutils literal"><span class="pre">render_context</span></code>. There may be multiple <code class="docutils literal"><span class="pre">CycleNodes</span></code> in a
given template, so we need to be careful not to clobber another node&#8217;s
state information. The easiest way to do this is to always use <code class="docutils literal"><span class="pre">self</span></code> as
the key into <code class="docutils literal"><span class="pre">render_context</span></code>. If you&#8217;re keeping track of several state
variables, make <code class="docutils literal"><span class="pre">render_context[self]</span></code> a dictionary.</p>
</div>
</div>
<div class="section" id="registering-the-tag">
<h3>Registering the tag<a class="headerlink" href="#registering-the-tag" title="Permalink to this headline">¶</a></h3>
<p>Finally, register the tag with your module&#8217;s <code class="docutils literal"><span class="pre">Library</span></code> instance, as explained
in &#8220;Writing custom template filters&#8221; above. Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">register</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s">&#39;current_time&#39;</span><span class="p">,</span> <span class="n">do_current_time</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">tag()</span></code> method takes two arguments:</p>
<ol class="arabic simple">
<li>The name of the template tag &#8211; a string. If this is left out, the
name of the compilation function will be used.</li>
<li>The compilation function &#8211; a Python function (not the name of the
function as a string).</li>
</ol>
<p>As with filter registration, it is also possible to use this as a decorator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@register.tag</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;current_time&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_current_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="o">...</span>

<span class="nd">@register.tag</span>
<span class="k">def</span> <span class="nf">shout</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>If you leave off the <code class="docutils literal"><span class="pre">name</span></code> argument, as in the second example above, Django
will use the function&#8217;s name as the tag name.</p>
</div>
<div class="section" id="passing-template-variables-to-the-tag">
<h3>Passing template variables to the tag<a class="headerlink" href="#passing-template-variables-to-the-tag" title="Permalink to this headline">¶</a></h3>
<p>Although you can pass any number of arguments to a template tag using
<code class="docutils literal"><span class="pre">token.split_contents()</span></code>, the arguments are all unpacked as
string literals. A little more work is required in order to pass dynamic
content (a template variable) to a template tag as an argument.</p>
<p>While the previous examples have formatted the current time into a string and
returned the string, suppose you wanted to pass in a
<code class="xref py py-class docutils literal"><span class="pre">DateTimeField</span></code> from an object and have the template
tag format that date-time:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="nt">&lt;p&gt;</span>This post was last updated at <span class="cp">{%</span> <span class="k">format_time</span> <span class="nv">blog_entry.date_updated</span> <span class="s2">&quot;%Y-%m-%d %I:%M %p&quot;</span> <span class="cp">%}</span>.<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>Initially, <code class="docutils literal"><span class="pre">token.split_contents()</span></code> will return three values:</p>
<ol class="arabic simple">
<li>The tag name <code class="docutils literal"><span class="pre">format_time</span></code>.</li>
<li>The string <code class="docutils literal"><span class="pre">'blog_entry.date_updated'</span></code> (without the surrounding
quotes).</li>
<li>The formatting string <code class="docutils literal"><span class="pre">'&quot;%Y-%m-%d</span> <span class="pre">%I:%M</span> <span class="pre">%p&quot;'</span></code>. The return value from
<code class="docutils literal"><span class="pre">split_contents()</span></code> will include the leading and trailing quotes for
string literals like this.</li>
</ol>
<p>Now your tag should begin to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="k">def</span> <span class="nf">do_format_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># split_contents() knows not to split quoted strings.</span>
        <span class="n">tag_name</span><span class="p">,</span> <span class="n">date_to_be_formatted</span><span class="p">,</span> <span class="n">format_string</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split_contents</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag requires exactly two arguments&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">format_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag&#39;s argument should be in quotes&quot;</span> <span class="o">%</span> <span class="n">tag_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FormatTimeNode</span><span class="p">(</span><span class="n">date_to_be_formatted</span><span class="p">,</span> <span class="n">format_string</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>You also have to change the renderer to retrieve the actual contents of the
<code class="docutils literal"><span class="pre">date_updated</span></code> property of the <code class="docutils literal"><span class="pre">blog_entry</span></code> object.  This can be
accomplished by using the <code class="docutils literal"><span class="pre">Variable()</span></code> class in <code class="docutils literal"><span class="pre">django.template</span></code>.</p>
<p>To use the <code class="docutils literal"><span class="pre">Variable</span></code> class, simply instantiate it with the name of the
variable to be resolved, and then call <code class="docutils literal"><span class="pre">variable.resolve(context)</span></code>. So,
for example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">FormatTimeNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_to_be_formatted</span><span class="p">,</span> <span class="n">format_string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_to_be_formatted</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">date_to_be_formatted</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="n">format_string</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">actual_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_to_be_formatted</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">actual_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">template</span><span class="o">.</span><span class="n">VariableDoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
</pre></div>
</div>
<p>Variable resolution will throw a <code class="docutils literal"><span class="pre">VariableDoesNotExist</span></code> exception if it
cannot resolve the string passed to it in the current context of the page.</p>
</div>
<div class="section" id="setting-a-variable-in-the-context">
<h3>Setting a variable in the context<a class="headerlink" href="#setting-a-variable-in-the-context" title="Permalink to this headline">¶</a></h3>
<p>The above examples simply output a value. Generally, it&#8217;s more flexible if your
template tags set template variables instead of outputting values. That way,
template authors can reuse the values that your template tags create.</p>
<p>To set a variable in the context, just use dictionary assignment on the context
object in the <code class="docutils literal"><span class="pre">render()</span></code> method. Here&#8217;s an updated version of
<code class="docutils literal"><span class="pre">CurrentTimeNode</span></code> that sets a template variable <code class="docutils literal"><span class="pre">current_time</span></code> instead of
outputting it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="k">class</span> <span class="nc">CurrentTimeNode2</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="n">format_string</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">context</span><span class="p">[</span><span class="s">&#39;current_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal"><span class="pre">render()</span></code> returns the empty string. <code class="docutils literal"><span class="pre">render()</span></code> should always
return string output. If all the template tag does is set a variable,
<code class="docutils literal"><span class="pre">render()</span></code> should return the empty string.</p>
<p>Here&#8217;s how you&#8217;d use this new version of the tag:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">current_time</span> <span class="s2">&quot;%Y-%M-%d %I:%M %p&quot;</span> <span class="cp">%}</span><span class="nt">&lt;p&gt;</span>The time is <span class="cp">{{</span> <span class="nv">current_time</span> <span class="cp">}}</span>.<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<div class="admonition-variable-scope-in-context admonition">
<p class="first admonition-title">Variable scope in context</p>
<p class="last">Any variable set in the context will only be available in the same
<code class="docutils literal"><span class="pre">block</span></code> of the template in which it was assigned. This behavior is
intentional; it provides a scope for variables so that they don&#8217;t conflict
with context in other blocks.</p>
</div>
<p>But, there&#8217;s a problem with <code class="docutils literal"><span class="pre">CurrentTimeNode2</span></code>: The variable name
<code class="docutils literal"><span class="pre">current_time</span></code> is hard-coded. This means you&#8217;ll need to make sure your
template doesn&#8217;t use <code class="docutils literal"><span class="pre">{{</span> <span class="pre">current_time</span> <span class="pre">}}</span></code> anywhere else, because the
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">current_time</span> <span class="pre">%}</span></code> will blindly overwrite that variable&#8217;s value. A cleaner
solution is to make the template tag specify the name of the output variable,
like so:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">current_time</span> <span class="s2">&quot;%Y-%M-%d %I:%M %p&quot;</span> <span class="k">as</span> <span class="nv">my_current_time</span> <span class="cp">%}</span>
<span class="nt">&lt;p&gt;</span>The current time is <span class="cp">{{</span> <span class="nv">my_current_time</span> <span class="cp">}}</span>.<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>To do that, you&#8217;ll need to refactor both the compilation function and <code class="docutils literal"><span class="pre">Node</span></code>
class, like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">CurrentTimeNode3</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="n">format_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">do_current_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="c"># This version uses a regular expression to parse tag contents.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Splitting by None == splitting by spaces.</span>
        <span class="n">tag_name</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag requires arguments&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;(.*?) as (\w+)&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag had invalid arguments&quot;</span> <span class="o">%</span> <span class="n">tag_name</span><span class="p">)</span>
    <span class="n">format_string</span><span class="p">,</span> <span class="n">var_name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">format_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag&#39;s argument should be in quotes&quot;</span> <span class="o">%</span> <span class="n">tag_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CurrentTimeNode3</span><span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">var_name</span><span class="p">)</span>
</pre></div>
</div>
<p>The difference here is that <code class="docutils literal"><span class="pre">do_current_time()</span></code> grabs the format string and
the variable name, passing both to <code class="docutils literal"><span class="pre">CurrentTimeNode3</span></code>.</p>
<p>Finally, if you only need to have a simple syntax for your custom
context-updating template tag, you might want to consider using the
assignment tag shortcut we introduced above.</p>
</div>
<div class="section" id="parsing-until-another-block-tag">
<h3>Parsing until another block tag<a class="headerlink" href="#parsing-until-another-block-tag" title="Permalink to this headline">¶</a></h3>
<p>Template tags can work in tandem. For instance, the standard
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}&lt;comment&gt;</span></code> tag hides everything until <code class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code>.
To create a template tag such as this, use <code class="docutils literal"><span class="pre">parser.parse()</span></code> in your
compilation function.</p>
<p>Here&#8217;s how a simplified <code class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> tag might be implemented:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">do_comment</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">nodelist</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">((</span><span class="s">&#39;endcomment&#39;</span><span class="p">,))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">delete_first_token</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">CommentNode</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">CommentNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The actual implementation of <code class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}&lt;comment&gt;</span></code> is slightly
different in that it allows broken template tags to appear between
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> and <code class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code>. It does so by calling
<code class="docutils literal"><span class="pre">parser.skip_past('endcomment')</span></code> instead of <code class="docutils literal"><span class="pre">parser.parse(('endcomment',))</span></code>
followed by <code class="docutils literal"><span class="pre">parser.delete_first_token()</span></code>, thus avoiding the generation of a
node list.</p>
</div>
<p><code class="docutils literal"><span class="pre">parser.parse()</span></code> takes a tuple of names of block tags &#8216;&#8217;to parse until&#8217;&#8216;. It
returns an instance of <code class="docutils literal"><span class="pre">django.template.NodeList</span></code>, which is a list of
all <code class="docutils literal"><span class="pre">Node</span></code> objects that the parser encountered &#8216;&#8217;before&#8217;&#8217; it encountered
any of the tags named in the tuple.</p>
<p>In <code class="docutils literal"><span class="pre">&quot;nodelist</span> <span class="pre">=</span> <span class="pre">parser.parse(('endcomment',))&quot;</span></code> in the above example,
<code class="docutils literal"><span class="pre">nodelist</span></code> is a list of all nodes between the <code class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> and
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code>, not counting <code class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> and <code class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code>
themselves.</p>
<p>After <code class="docutils literal"><span class="pre">parser.parse()</span></code> is called, the parser hasn&#8217;t yet &#8220;consumed&#8221; the
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code> tag, so the code needs to explicitly call
<code class="docutils literal"><span class="pre">parser.delete_first_token()</span></code>.</p>
<p><code class="docutils literal"><span class="pre">CommentNode.render()</span></code> simply returns an empty string. Anything between
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> and <code class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code> is ignored.</p>
</div>
<div class="section" id="parsing-until-another-block-tag-and-saving-contents">
<h3>Parsing until another block tag, and saving contents<a class="headerlink" href="#parsing-until-another-block-tag-and-saving-contents" title="Permalink to this headline">¶</a></h3>
<p>In the previous example, <code class="docutils literal"><span class="pre">do_comment()</span></code> discarded everything between
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></code> and <code class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></code>. Instead of doing that, it&#8217;s
possible to do something with the code between block tags.</p>
<p>For example, here&#8217;s a custom template tag, <code class="docutils literal"><span class="pre">{%</span> <span class="pre">upper</span> <span class="pre">%}</span></code>, that capitalizes
everything between itself and <code class="docutils literal"><span class="pre">{%</span> <span class="pre">endupper</span> <span class="pre">%}</span></code>.</p>
<p>Usage:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">upper</span> <span class="cp">%}</span>This will appear in uppercase, <span class="cp">{{</span> <span class="nv">your_name</span> <span class="cp">}}</span>.<span class="cp">{%</span> <span class="k">endupper</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>As in the previous example, we&#8217;ll use <code class="docutils literal"><span class="pre">parser.parse()</span></code>. But this time, we
pass the resulting <code class="docutils literal"><span class="pre">nodelist</span></code> to the <code class="docutils literal"><span class="pre">Node</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">do_upper</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">nodelist</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">((</span><span class="s">&#39;endupper&#39;</span><span class="p">,))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">delete_first_token</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">UpperNode</span><span class="p">(</span><span class="n">nodelist</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UpperNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodelist</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodelist</span> <span class="o">=</span> <span class="n">nodelist</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>
</div>
<p>The only new concept here is the <code class="docutils literal"><span class="pre">self.nodelist.render(context)</span></code> in
<code class="docutils literal"><span class="pre">UpperNode.render()</span></code>.</p>
<p>For more examples of complex rendering, see the source code of
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">for</span> <span class="pre">%}&lt;for&gt;</span></code> in <code class="docutils literal"><span class="pre">django/template/defaulttags.py</span></code> and
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">%}&lt;if&gt;</span></code> in <code class="docutils literal"><span class="pre">django/template/smartif.py</span></code>.</p>
</div>
</div>
<div class="section" id="what-s-next">
<h2>What&#8217;s Next<a class="headerlink" href="#what-s-next" title="Permalink to this headline">¶</a></h2>
<p>Continuing this section&#8217;s theme of advanced topics, the next chapter covers
advanced usage of Django models.</p>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="front_matter.html">Frontmatter</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction_django.html">Introduction to Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_01.html">Chapter 1: Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_02.html">Chapter 2: Views and URLconfs</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_03.html">Chapter 3: Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_04.html">Chapter 4: Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_05.html">Chapter 5: The Django Admin Site</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_06.html">Chapter 6: Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_07.html">Chapter 7: Advanced Views and URLconfs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Chapter 8: Advanced Templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#template-language-review">Template Language Review</a></li>
<li class="toctree-l2"><a class="reference internal" href="#requestcontext-and-context-processors">RequestContext and Context Processors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#guidelines-for-writing-your-own-context-processors">Guidelines for Writing Your Own Context Processors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#automatic-html-escaping">Automatic HTML Escaping</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inside-template-loading">Inside Template Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="#extending-the-template-system">Extending the Template System</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-template-tags-and-filters">Custom template tags and filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-s-next">What&#8217;s Next</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter_09.html">Chapter 9: Advanced Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_10.html">Chapter 10: Generic Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_11.html">Chapter 11: User authentication in Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_12.html">Chapter 12 - testing in Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_13.html">Chapter 13: Deploying Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_14.html">Chapter 14 - How to write reusable apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_15.html">Chapter 15: Generating Non-HTML Content</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_16.html">Chapter 16 - Django sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_17.html">Chapter 17 - Django&#8217;s cache framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_18.html">Chapter 18 - Other core Django functionalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_19.html">Chapter 19 - Django Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_20.html">Chapter 20: Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_21.html">Chapter 21: Security in Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_22.html">How to install Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_23.html">Chapter 23: Advanced database management</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_A.html">Appendix A: Model Definition Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_B.html">Appendix B: Database API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_C.html">Appendix C: Generic View Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_D.html">Appendix D: Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_E.html">Appendix E: Built-in Template Tags and Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_F.html">Appendix F: The django-admin Utility</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_G.html">Appendix G: Request and Response Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License &amp; Copyright</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
            <p class="searchtip" style="font-size: 90%">
                Enter search terms or a module, class or function name.
            </p>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="chapter_07.html" title="Chapter 7: Advanced Views and URLconfs"
              >previous</a> |
            <a href="chapter_09.html" title="Chapter 9: Advanced Models"
              >next</a> |
            <a href="py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
              <br/>
              <a href="_sources/chapter_08.txt"
                rel="nofollow">Show Source</a>
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Nigel George.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>