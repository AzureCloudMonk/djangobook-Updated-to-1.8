<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 6: Forms &mdash; Mastering Django</title>
    
    <link rel="stylesheet" href="_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Mastering Django" href="index.html" />
    <link rel="next" title="Chapter 7: Advanced Views and URLconfs" href="chapter_07.html" />
    <link rel="prev" title="Chapter 5: The Django Admin Site" href="chapter_05.html" /> 
  </head>
  <body role="document">
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="index.html">Mastering Django</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="chapter_05.html" title="Chapter 5: The Django Admin Site"
             accesskey="P">previous</a> |
          <a href="chapter_07.html" title="Chapter 7: Advanced Views and URLconfs"
             accesskey="N">next</a> |
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="chapter-6-forms">
<h1>Chapter 6: Forms<a class="headerlink" href="#chapter-6-forms" title="Permalink to this headline">¶</a></h1>
<p>HTML forms are the backbone of interactive Web sites, from the simplicity of
Google&#8217;s single search box to ubiquitous blog comment-submission forms to
complex custom data-entry interfaces. This chapter covers how you can use
Django to access user-submitted form data, validate it and do something with
it. Along the way, we&#8217;ll cover <code class="docutils literal"><span class="pre">HttpRequest</span></code> and <code class="docutils literal"><span class="pre">Form</span></code> objects.</p>
<div class="section" id="getting-data-from-the-request-object">
<h2>Getting Data From the Request Object<a class="headerlink" href="#getting-data-from-the-request-object" title="Permalink to this headline">¶</a></h2>
<p>We introduced <code class="docutils literal"><span class="pre">HttpRequest</span></code> objects in Chapter 2 when we first covered view
functions, but we didn&#8217;t have much to say about them at the time. Recall that
each view function takes an <code class="docutils literal"><span class="pre">HttpRequest</span></code> object as its first parameter, as
in our <code class="docutils literal"><span class="pre">hello()</span></code> view:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">HttpRequest</span></code> objects, such as the variable <code class="docutils literal"><span class="pre">request</span></code> here, have a number
of interesting attributes and methods that you should familiarize yourself
with, so that you know what&#8217;s possible. You can use these attributes to get
information about the current request (i.e., the user/Web browser that&#8217;s
loading the current page on your Django-powered site), at the time the view
function is executed.</p>
<div class="section" id="information-about-the-url">
<h3>Information About the URL<a class="headerlink" href="#information-about-the-url" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">HttpRequest</span></code> objects contain several pieces of information about the
currently requested URL:</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="41%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute/method</th>
<th class="head">Description</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">request.path</span></code></td>
<td>The full path, not including the
domain but including the leading
slash.</td>
<td><code class="docutils literal"><span class="pre">&quot;/hello/&quot;</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">request.get_host()</span></code></td>
<td>The host (i.e., the &#8220;domain,&#8221; in
common parlance).</td>
<td><code class="docutils literal"><span class="pre">&quot;127.0.0.1:8000&quot;</span></code>
or <code class="docutils literal"><span class="pre">&quot;www.example.com&quot;</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">request.get_full_path()</span></code></td>
<td>The <code class="docutils literal"><span class="pre">path</span></code>, plus a query string
(if available).</td>
<td><code class="docutils literal"><span class="pre">&quot;/hello/?print=true&quot;</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">request.is_secure()</span></code></td>
<td><code class="docutils literal"><span class="pre">True</span></code> if the request was made via
HTTPS. Otherwise, <code class="docutils literal"><span class="pre">False</span></code>.</td>
<td><code class="docutils literal"><span class="pre">True</span></code> or <code class="docutils literal"><span class="pre">False</span></code></td>
</tr>
</tbody>
</table>
<p>Always use these attributes/methods instead of hard-coding URLs in your views.
This makes for more flexible code that can be reused in other places. A
simplistic example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># BAD!</span>
<span class="k">def</span> <span class="nf">current_url_view_bad</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Welcome to the page at /current/&quot;</span><span class="p">)</span>

<span class="c"># GOOD</span>
<span class="k">def</span> <span class="nf">current_url_view_good</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Welcome to the page at </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="other-information-about-the-request">
<h3>Other Information About the Request<a class="headerlink" href="#other-information-about-the-request" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">request.META</span></code> is a Python dictionary containing all available HTTP headers
for the given request &#8211; including the user&#8217;s IP address and user agent
(generally the name and version of the Web browser). Note that the full list
of available headers depends on which headers the user sent and which headers
your Web server sets. Some commonly available keys in this dictionary are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">HTTP_REFERER</span></code> &#8211; The referring URL, if any. (Note the misspelling of
<code class="docutils literal"><span class="pre">REFERER</span></code>.)</li>
<li><code class="docutils literal"><span class="pre">HTTP_USER_AGENT</span></code> &#8211; The user&#8217;s browser&#8217;s user-agent string, if any.
This looks something like: <code class="docutils literal"><span class="pre">&quot;Mozilla/5.0</span> <span class="pre">(X11;</span> <span class="pre">U;</span> <span class="pre">Linux</span> <span class="pre">i686;</span> <span class="pre">fr-FR;</span> <span class="pre">rv:1.8.1.17)</span> <span class="pre">Gecko/20080829</span> <span class="pre">Firefox/2.0.0.17&quot;</span></code>.</li>
<li><code class="docutils literal"><span class="pre">REMOTE_ADDR</span></code> &#8211; The IP address of the client, e.g., <code class="docutils literal"><span class="pre">&quot;12.345.67.89&quot;</span></code>.
(If the request has passed through any proxies, then this might be a
comma-separated list of IP addresses, e.g., <code class="docutils literal"><span class="pre">&quot;12.345.67.89,23.456.78.90&quot;</span></code>.)</li>
</ul>
<p>Note that because <code class="docutils literal"><span class="pre">request.META</span></code> is just a basic Python dictionary, you&#8217;ll
get a <code class="docutils literal"><span class="pre">KeyError</span></code> exception if you try to access a key that doesn&#8217;t exist.
(Because HTTP headers are <em>external</em> data &#8211; that is, they&#8217;re submitted by your
users&#8217; browsers &#8211; they shouldn&#8217;t be trusted, and you should always design your
application to fail gracefully if a particular header is empty or doesn&#8217;t
exist.) You should either use a <code class="docutils literal"><span class="pre">try</span></code>/<code class="docutils literal"><span class="pre">except</span></code> clause or the <code class="docutils literal"><span class="pre">get()</span></code>
method to handle the case of undefined keys:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># BAD!</span>
<span class="k">def</span> <span class="nf">ua_display_bad</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">ua</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]</span>  <span class="c"># Might raise KeyError!</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Your browser is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ua</span><span class="p">)</span>

<span class="c"># GOOD (VERSION 1)</span>
<span class="k">def</span> <span class="nf">ua_display_good1</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ua</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">ua</span> <span class="o">=</span> <span class="s">&#39;unknown&#39;</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Your browser is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ua</span><span class="p">)</span>

<span class="c"># GOOD (VERSION 2)</span>
<span class="k">def</span> <span class="nf">ua_display_good2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">ua</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_USER_AGENT&#39;</span><span class="p">,</span> <span class="s">&#39;unknown&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Your browser is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ua</span><span class="p">)</span>
</pre></div>
</div>
<p>We encourage you to write a small view that displays all of the
<code class="docutils literal"><span class="pre">request.META</span></code> data so you can get to know what&#8217;s in there. Here&#8217;s what that
view might look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">display_meta</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="n">values</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">html</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">html</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;tr&gt;&lt;td&gt;</span><span class="si">%s</span><span class="s">&lt;/td&gt;&lt;td&gt;</span><span class="si">%s</span><span class="s">&lt;/td&gt;&lt;/tr&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;&lt;table&gt;</span><span class="si">%s</span><span class="s">&lt;/table&gt;&#39;</span> <span class="o">%</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html</span><span class="p">))</span>
</pre></div>
</div>
<p>Another good way to see what sort of information that the request object
contains is to look closely at the Django error pages when you crash the
system &#8211; there is a wealth of useful information in there - including all the
HTTP headers and other request objects (<code class="docutils literal"><span class="pre">request.path</span></code> for example).</p>
</div>
<div class="section" id="information-about-submitted-data">
<h3>Information About Submitted Data<a class="headerlink" href="#information-about-submitted-data" title="Permalink to this headline">¶</a></h3>
<p>Beyond basic metadata about the request, <code class="docutils literal"><span class="pre">HttpRequest</span></code> objects have two
attributes that contain information submitted by the user: <code class="docutils literal"><span class="pre">request.GET</span></code> and
<code class="docutils literal"><span class="pre">request.POST</span></code>. Both of these are dictionary-like objects that give you
access to <code class="docutils literal"><span class="pre">GET</span></code> and <code class="docutils literal"><span class="pre">POST</span></code> data.</p>
<div class="admonition-dictionary-like-objects admonition">
<p class="first admonition-title">Dictionary-like objects</p>
<p>When we say <code class="docutils literal"><span class="pre">request.GET</span></code> and <code class="docutils literal"><span class="pre">request.POST</span></code> are &#8220;dictionary-like&#8221;
objects, we mean that they behave like standard Python dictionaries but
aren&#8217;t technically dictionaries under the hood. For example,
<code class="docutils literal"><span class="pre">request.GET</span></code> and <code class="docutils literal"><span class="pre">request.POST</span></code> both have <code class="docutils literal"><span class="pre">get()</span></code>, <code class="docutils literal"><span class="pre">keys()</span></code>
and <code class="docutils literal"><span class="pre">values()</span></code> methods, and you can iterate over the keys by doing
<code class="docutils literal"><span class="pre">for</span> <span class="pre">key</span> <span class="pre">in</span> <span class="pre">request.GET</span></code>.</p>
<p>So why the distinction? Because both <code class="docutils literal"><span class="pre">request.GET</span></code> and <code class="docutils literal"><span class="pre">request.POST</span></code>
have additional methods that normal dictionaries don&#8217;t have. We&#8217;ll get into
these in a short while.</p>
<p class="last">You might have encountered the similar term &#8220;file-like objects&#8221; &#8211; Python
objects that have a few basic methods, like <code class="docutils literal"><span class="pre">read()</span></code>, that let them
act as stand-ins for &#8220;real&#8221; file objects.</p>
</div>
<p><code class="docutils literal"><span class="pre">POST</span></code> data generally is submitted from an HTML <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code>, while <code class="docutils literal"><span class="pre">GET</span></code>
data can come from a <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> or the query string in the page&#8217;s URL.</p>
</div>
</div>
<div class="section" id="a-simple-form-handling-example">
<h2>A Simple Form-Handling Example<a class="headerlink" href="#a-simple-form-handling-example" title="Permalink to this headline">¶</a></h2>
<p>Continuing this book&#8217;s ongoing example of books, authors and publishers, let&#8217;s
create a simple view that lets users search our book database by title.</p>
<p>Generally, there are two parts to developing a form: the HTML user interface
and the backend view code that processes the submitted data. The first part is
easy; let&#8217;s just set up a view that displays a search form:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="k">def</span> <span class="nf">search_form</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;search_form.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>As we learned in Chapter 3, this view can live anywhere on your Python path.
For sake of argument, put it in <code class="docutils literal"><span class="pre">books/views.py</span></code>.</p>
<p>The accompanying template, <code class="docutils literal"><span class="pre">search_form.html</span></code>, could look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Search&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form action=&quot;/search/&quot; method=&quot;get&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;q&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Search&quot;&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>Save this file to your <code class="docutils literal"><span class="pre">mysite/templates</span></code> directory you created in Chapter
3, or you can create a new folder <code class="docutils literal"><span class="pre">books/templates</span></code>. Just make sure you have
<code class="docutils literal"><span class="pre">'APP_DIRS'</span></code> in your settings file set to <code class="docutils literal"><span class="pre">True</span></code>.</p>
<p>The URLpattern in <code class="docutils literal"><span class="pre">urls.py</span></code> could look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">books</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^search-form/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">search_form</span><span class="p">),</span>
    <span class="c"># ...</span>
<span class="p">]</span>
</pre></div>
</div>
<p>(Note that we&#8217;re importing the <code class="docutils literal"><span class="pre">views</span></code> module directly, instead of something
like <code class="docutils literal"><span class="pre">from</span> <span class="pre">mysite.views</span> <span class="pre">import</span> <span class="pre">search_form</span></code>, because the former is less
verbose. We&#8217;ll cover this importing approach in more detail in Chapter 7.)</p>
<p>Now, if you run the <code class="docutils literal"><span class="pre">runserver</span></code> and visit
<code class="docutils literal"><span class="pre">http://127.0.0.1:8000/search-form/</span></code>, you&#8217;ll see the search interface. Simple
enough.</p>
<p>Try submitting the form, though, and you&#8217;ll get a Django 404 error. The form
points to the URL <code class="docutils literal"><span class="pre">/search/</span></code>, which hasn&#8217;t yet been implemented. Let&#8217;s fix
that with a second view function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># urls.py</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># ...</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^search-form/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">search_form</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^search/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">search</span><span class="p">),</span>
    <span class="c"># ...</span>
<span class="p">]</span>

<span class="c"># books/views.py</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="c"># ...</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;q&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;You searched for: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;You submitted an empty form.&#39;</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>For the moment, this merely displays the user&#8217;s search term, so we can make
sure the data is being submitted to Django properly, and so you can get a feel
for how the search term flows through the system. In short:</p>
<ol class="arabic simple">
<li>The HTML <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> defines a variable <code class="docutils literal"><span class="pre">q</span></code>. When it&#8217;s submitted, the
value of <code class="docutils literal"><span class="pre">q</span></code> is sent via <code class="docutils literal"><span class="pre">GET</span></code> (<code class="docutils literal"><span class="pre">method=&quot;get&quot;</span></code>) to the URL
<code class="docutils literal"><span class="pre">/search/</span></code>.</li>
<li>The Django view that handles the URL <code class="docutils literal"><span class="pre">/search/</span></code> (<code class="docutils literal"><span class="pre">search()</span></code>) has
access to the <code class="docutils literal"><span class="pre">q</span></code> value in <code class="docutils literal"><span class="pre">request.GET</span></code>.</li>
</ol>
<p>An important thing to point out here is that we explicitly check that <code class="docutils literal"><span class="pre">'q'</span></code>
exists in <code class="docutils literal"><span class="pre">request.GET</span></code>. As we pointed out in the <code class="docutils literal"><span class="pre">request.META</span></code> section
above, you shouldn&#8217;t trust anything submitted by users or even assume that
they&#8217;ve submitted anything in the first place. If we didn&#8217;t add this check, any
submission of an empty form would raise <code class="docutils literal"><span class="pre">KeyError</span></code> in the view:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># BAD!</span>
<span class="k">def</span> <span class="nf">bad_search</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># The following line will raise KeyError if &#39;q&#39; hasn&#39;t</span>
    <span class="c"># been submitted!</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;You searched for: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition-query-string-parameters admonition">
<p class="first admonition-title">Query string parameters</p>
<p class="last">Because <code class="docutils literal"><span class="pre">GET</span></code> data is passed in the query string (e.g.,
<code class="docutils literal"><span class="pre">/search/?q=django</span></code>), you can use <code class="docutils literal"><span class="pre">request.GET</span></code> to access query string
variables. In Chapter 2&#8217;s introduction of Django&#8217;s URLconf system, we
compared Django&#8217;s pretty URLs to more traditional PHP/Java URLs such as
<code class="docutils literal"><span class="pre">/time/plus?hours=3</span></code> and said we&#8217;d show you how to do the latter in
Chapter 6. Now you know how to access query string parameters in your
views (like <code class="docutils literal"><span class="pre">hours=3</span></code> in this example) &#8211; use <code class="docutils literal"><span class="pre">request.GET</span></code>.</p>
</div>
<p><code class="docutils literal"><span class="pre">POST</span></code> data works the same way as <code class="docutils literal"><span class="pre">GET</span></code> data &#8211; just use <code class="docutils literal"><span class="pre">request.POST</span></code>
instead of <code class="docutils literal"><span class="pre">request.GET</span></code>. What&#8217;s the difference between <code class="docutils literal"><span class="pre">GET</span></code> and <code class="docutils literal"><span class="pre">POST</span></code>?
Use <code class="docutils literal"><span class="pre">GET</span></code> when the act of submitting the form is just a request to &#8220;get&#8221;
data. Use <code class="docutils literal"><span class="pre">POST</span></code> whenever the act of submitting the form will have some side
effect &#8211; <em>changing</em> data, or sending an e-mail, or something else that&#8217;s
beyond simple <em>display</em> of data. In our book-search example, we&#8217;re using
<code class="docutils literal"><span class="pre">GET</span></code> because the query doesn&#8217;t change any data on our server. (See
<a class="reference external" href="http://www.w3.org/2001/tag/doc/whenToUseGet.html">http://www.w3.org/2001/tag/doc/whenToUseGet.html</a> if you want to learn more
about <code class="docutils literal"><span class="pre">GET</span></code> and <code class="docutils literal"><span class="pre">POST</span></code>.)</p>
<p>Now that we&#8217;ve verified <code class="docutils literal"><span class="pre">request.GET</span></code> is being passed in properly, let&#8217;s hook
the user&#8217;s search query into our book database (again, in <code class="docutils literal"><span class="pre">views.py</span></code>):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">books.models</span> <span class="kn">import</span> <span class="n">Book</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;q&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span>
        <span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__icontains</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;search_results.html&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;books&#39;</span><span class="p">:</span> <span class="n">books</span><span class="p">,</span> <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="n">q</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;Please submit a search term.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>A couple of notes on what we did here:</p>
<ul>
<li><p class="first">Aside from checking that <code class="docutils literal"><span class="pre">'q'</span></code> exists in <code class="docutils literal"><span class="pre">request.GET</span></code>, we also make
sure that <code class="docutils literal"><span class="pre">request.GET['q']</span></code> is a non-empty value before passing it to
the database query.</p>
</li>
<li><p class="first">We&#8217;re using <code class="docutils literal"><span class="pre">Book.objects.filter(title__icontains=q)</span></code> to query our
book table for all books whose title includes the given submission. The
<code class="docutils literal"><span class="pre">icontains</span></code> is a lookup type (as explained in Chapter 4 and Appendix
B), and the statement can be roughly translated as &#8220;Get the books whose
title contains <code class="docutils literal"><span class="pre">q</span></code>, without being case-sensitive.&#8221;</p>
<p>This is a very simple way to do a book search. We wouldn&#8217;t recommend
using a simple <code class="docutils literal"><span class="pre">icontains</span></code> query on a large production database, as
it can be slow. (In the real world, you&#8217;d want to use a custom search
system of some sort. Search the Web for <em>open-source full-text search</em>
to get an idea of the possibilities.)</p>
</li>
<li><p class="first">We pass <code class="docutils literal"><span class="pre">books</span></code>, a list of <code class="docutils literal"><span class="pre">Book</span></code> objects, to the template. The
<code class="docutils literal"><span class="pre">search_results.html</span></code> file might include something like
this:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;html&gt;
  &lt;head&gt;
      &lt;title&gt;Book Search&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;You searched for: &lt;strong&gt;{{ query }}&lt;/strong&gt;&lt;/p&gt;

    {% if books %}
        &lt;p&gt;Found {{ books|length }} book{{ books|pluralize }}.&lt;/p&gt;
        &lt;ul&gt;
            {% for book in books %}
            &lt;li&gt;{{ book.title }}&lt;/li&gt;
            {% endfor %}
        &lt;/ul&gt;
    {% else %}
        &lt;p&gt;No books matched your search criteria.&lt;/p&gt;
    {% endif %}

  &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>Note usage of the <code class="docutils literal"><span class="pre">pluralize</span></code> template filter, which outputs an &#8220;s&#8221;
if appropriate, based on the number of books found.</p>
</li>
</ul>
</div>
<div class="section" id="improving-our-simple-form-handling-example">
<h2>Improving Our Simple Form-Handling Example<a class="headerlink" href="#improving-our-simple-form-handling-example" title="Permalink to this headline">¶</a></h2>
<p>As in previous chapters, we&#8217;ve shown you the simplest thing that could possibly
work. Now we&#8217;ll point out some problems and show you how to improve it.</p>
<p>First, our <code class="docutils literal"><span class="pre">search()</span></code> view&#8217;s handling of an empty query is poor &#8211; we&#8217;re just
displaying a <code class="docutils literal"><span class="pre">&quot;Please</span> <span class="pre">submit</span> <span class="pre">a</span> <span class="pre">search</span> <span class="pre">term.&quot;</span></code> message, requiring the user to
hit the browser&#8217;s back button. This is horrid and unprofessional, and if you
ever actually implement something like this in the wild, your Django privileges
will be revoked.</p>
<p>It would be much better to redisplay the form, with an error above it, so that
the user can try again immediately. The easiest way to do that would be to
render the template again, like this:</p>
<pre class="literal-block">
from django.http import HttpResponse
from django.shortcuts import render
from books.models import Book

def search_form(request):
    return render(request, 'search_form.html')

def search(request):
    if 'q' in request.GET and request.GET['q']:
        q = request.GET['q']
        books = Book.objects.filter(title__icontains=q)
        return render(request, 'search_results.html',
            {'books': books, 'query': q})
    else:
        <strong>return render(request, 'search_form.html', {'error': True})</strong>
</pre>
<p>(Note that we&#8217;ve included <code class="docutils literal"><span class="pre">search_form()</span></code> here so you can see both views in
one place.)</p>
<p>Here, we&#8217;ve improved <code class="docutils literal"><span class="pre">search()</span></code> to render the <code class="docutils literal"><span class="pre">search_form.html</span></code> template
again, if the query is empty. And because we need to display an error message
in that template, we pass a template variable. Now we can edit
<code class="docutils literal"><span class="pre">search_form.html</span></code> to check for the <code class="docutils literal"><span class="pre">error</span></code> variable:</p>
<pre class="literal-block">
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Search&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    <strong>{% if error %}</strong>
        <strong>&lt;p style=&quot;color: red;&quot;&gt;Please submit a search term.&lt;/p&gt;</strong>
    <strong>{% endif %}</strong>
    &lt;form action=&quot;/search/&quot; method=&quot;get&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;q&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Search&quot;&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<p>We can still use this template from our original view, <code class="docutils literal"><span class="pre">search_form()</span></code>,
because <code class="docutils literal"><span class="pre">search_form()</span></code> doesn&#8217;t pass <code class="docutils literal"><span class="pre">error</span></code> to the template &#8211; so the
error message won&#8217;t show up in that case.</p>
<p>With this change in place, it&#8217;s a better application, but it now begs the
question: is a dedicated <code class="docutils literal"><span class="pre">search_form()</span></code> view really necessary? As it stands,
a request to the URL <code class="docutils literal"><span class="pre">/search/</span></code> (without any <code class="docutils literal"><span class="pre">GET</span></code> parameters) will display
the empty form (but with an error). We can remove the <code class="docutils literal"><span class="pre">search_form()</span></code> view,
along with its associated URLpattern, as long as we change <code class="docutils literal"><span class="pre">search()</span></code> to
hide the error message when somebody visits <code class="docutils literal"><span class="pre">/search/</span></code> with no <code class="docutils literal"><span class="pre">GET</span></code>
parameters:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="s">&#39;q&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__icontains</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;search_results.html&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s">&#39;books&#39;</span><span class="p">:</span> <span class="n">books</span><span class="p">,</span> <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="n">q</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;search_form.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
</pre></div>
</div>
<p>In this updated view, if a user visits <code class="docutils literal"><span class="pre">/search/</span></code> with no <code class="docutils literal"><span class="pre">GET</span></code> parameters,
he&#8217;ll see the search form with no error message. If a user submits the form
with an empty value for <code class="docutils literal"><span class="pre">'q'</span></code>, he&#8217;ll see the search form <em>with</em> an error
message. And, finally, if a user submits the form with a non-empty value for
<code class="docutils literal"><span class="pre">'q'</span></code>, he&#8217;ll see the search results.</p>
<p>We can make one final improvement to this application, to remove a bit of
redundancy. Now that we&#8217;ve rolled the two views and URLs into one and
<code class="docutils literal"><span class="pre">/search/</span></code> handles both search-form display and result display, the HTML
<code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> in <code class="docutils literal"><span class="pre">search_form.html</span></code> doesn&#8217;t have to hard-code a URL. Instead
of this:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;form action=&quot;/search/&quot; method=&quot;get&quot;&gt;
</pre></div>
</div>
<p>It can be changed to this:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;form action=&quot;&quot; method=&quot;get&quot;&gt;
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">action=&quot;&quot;</span></code> means &#8220;Submit the form to the same URL as the current page.&#8221;
With this change in place, you won&#8217;t have to remember to change the <code class="docutils literal"><span class="pre">action</span></code>
if you ever hook the <code class="docutils literal"><span class="pre">search()</span></code> view to another URL.</p>
</div>
<div class="section" id="simple-validation">
<h2>Simple validation<a class="headerlink" href="#simple-validation" title="Permalink to this headline">¶</a></h2>
<p>Our search example is still reasonably simple, particularly in terms of its
data validation; we&#8217;re merely checking to make sure the search query isn&#8217;t
empty. Many HTML forms include a level of validation that&#8217;s more complex than
making sure the value is non-empty. We&#8217;ve all seen the error messages on Web
sites:</p>
<ul class="simple">
<li>&#8220;Please enter a valid e-mail address. &#8216;foo&#8217; is not an e-mail address.&#8221;</li>
<li>&#8220;Please enter a valid five-digit U.S. ZIP code. &#8216;123&#8217; is not a ZIP code.&#8221;</li>
<li>&#8220;Please enter a valid date in the format YYYY-MM-DD.&#8221;</li>
<li>&#8220;Please enter a password that is at least 8 characters long and contains
at least one number.&#8221;</li>
</ul>
<div class="admonition-a-note-on-javascript-validation admonition">
<p class="first admonition-title">A note on JavaScript validation</p>
<p>This is beyond the scope of this book, but you can use JavaScript to
validate data on the client side, directly in the browser. But be warned:
even if you do this, you <em>must</em> validate data on the server side, too. Some
people have JavaScript turned off, and some malicious users might submit
raw, unvalidated data directly to your form handler to see whether they can
cause mischief.</p>
<p class="last">There&#8217;s nothing you can do about this, other than <em>always</em> validate
user-submitted data server-side (i.e., in your Django views). You should
think of JavaScript validation as a bonus usability feature, not as your
only means of validating.</p>
</div>
<p>Let&#8217;s tweak our <code class="docutils literal"><span class="pre">search()</span></code> view so that it validates that the search term is
less than or equal to 20 characters long. (For sake of example, let&#8217;s say
anything longer than that might make the query too slow.) How might we do that?
The simplest possible thing would be to embed the logic directly in the view,
like this:</p>
<pre class="literal-block">
def search(request):
    error = False
    if 'q' in request.GET:
        q = request.GET['q']
        if not q:
            error = True
        <strong>elif len(q) &gt; 20:</strong>
            <strong>error = True</strong>
        else:
            books = Book.objects.filter(title__icontains=q)
            return render(request, 'search_results.html',
                {'books': books, 'query': q})
    return render(request, 'search_form.html',
        {'error': error})
</pre>
<p>Now, if you try submitting a search query greater than 20 characters long,
it won&#8217;t let you search; you&#8217;ll get an error message. But that error message
in <code class="docutils literal"><span class="pre">search_form.html</span></code> currently says <code class="docutils literal"><span class="pre">&quot;Please</span> <span class="pre">submit</span> <span class="pre">a</span> <span class="pre">search</span> <span class="pre">term.&quot;</span></code> &#8211;
so we&#8217;ll have to change it to be accurate for both cases:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Search&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    {% if error %}
        &lt;p style=&quot;color: red;&quot;&gt;Please submit a search term 20 characters or shorter.&lt;/p&gt;
    {% endif %}
    &lt;form action=&quot;/search/&quot; method=&quot;get&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;q&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Search&quot;&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>There&#8217;s something ugly about this. Our one-size-fits-all error message is
potentially confusing. Why should the error message for an empty form
submission mention anything about a 20-character limit? Error messages should
be specific, unambiguous and not confusing.</p>
<p>The problem is in the fact that we&#8217;re using a simple boolean value for
<code class="docutils literal"><span class="pre">error</span></code>, whereas we should be using a <em>list</em> of error message strings. Here&#8217;s
how we might fix that:</p>
<pre class="literal-block">
def search(request):
    <strong>errors = []</strong>
    if 'q' in request.GET:
        q = request.GET['q']
        if not q:
            <strong>errors.append('Enter a search term.')</strong>
        elif len(q) &gt; 20:
            <strong>errors.append('Please enter at most 20 characters.')</strong>
        else:
            books = Book.objects.filter(title__icontains=q)
            return render(request, 'search_results.html',
                {'books': books, 'query': q})
    return render(request, 'search_form.html',
        {<strong>'errors': errors</strong>})
</pre>
<p>Then, we need make a small tweak to the <code class="docutils literal"><span class="pre">search_form.html</span></code> template to
reflect that it&#8217;s now passed an <code class="docutils literal"><span class="pre">errors</span></code> list instead of an <code class="docutils literal"><span class="pre">error</span></code> boolean
value:</p>
<pre class="literal-block">
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Search&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    <strong>{% if errors %}</strong>
        <strong>&lt;ul&gt;</strong>
            <strong>{% for error in errors %}</strong>
            <strong>&lt;li&gt;{{ error }}&lt;/li&gt;</strong>
            <strong>{% endfor %}</strong>
        <strong>&lt;/ul&gt;</strong>
    <strong>{% endif %}</strong>
    &lt;form action=&quot;/search/&quot; method=&quot;get&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;q&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Search&quot;&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div>
<div class="section" id="making-a-contact-form">
<h2>Making a Contact Form<a class="headerlink" href="#making-a-contact-form" title="Permalink to this headline">¶</a></h2>
<p>Although we iterated over the book search form example several times and
improved it nicely, it&#8217;s still fundamentally simple: just a single field,
<code class="docutils literal"><span class="pre">'q'</span></code>. As forms get more complex, we have to repeat the above steps over and
over again for each form field we use. This introduces a lot of cruft and a
lot of opportunities for human error. Lucky for us, the Django developers
thought of this and built into Django a higher-level library that handles
form- and validation-related tasks.</p>
<div class="section" id="your-first-form-class">
<h3>Your First Form Class<a class="headerlink" href="#your-first-form-class" title="Permalink to this headline">¶</a></h3>
<p>Django comes with a form library, called <code class="docutils literal"><span class="pre">django.forms</span></code>, that handles many of
the issues we&#8217;ve been exploring this chapter &#8211; from HTML form display to
validation. Let&#8217;s dive in and rework our contact form application using the
Django forms framework.</p>
<p>The primary way to use the forms framework is to define a <code class="docutils literal"><span class="pre">Form</span></code> class for
each HTML <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> you&#8217;re dealing with. In our case, we only have one
<code class="docutils literal"><span class="pre">&lt;form&gt;</span></code>, so we&#8217;ll have one <code class="docutils literal"><span class="pre">Form</span></code> class. This class can live anywhere you
want &#8211; including directly in your <code class="docutils literal"><span class="pre">views.py</span></code> file &#8211; but community
convention is to keep <code class="docutils literal"><span class="pre">Form</span></code> classes in a separate file called <code class="docutils literal"><span class="pre">forms.py</span></code>.
Create this file in the same directory as your <code class="docutils literal"><span class="pre">mysite/views.py</span></code>, and enter the
following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="k">class</span> <span class="nc">ContactForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
</pre></div>
</div>
<p>This is pretty intuitive, and it&#8217;s similar to Django&#8217;s model syntax. Each field
in the form is represented by a type of <code class="docutils literal"><span class="pre">Field</span></code> class &#8211; <code class="docutils literal"><span class="pre">CharField</span></code> and
<code class="docutils literal"><span class="pre">EmailField</span></code> are the only types of fields used here &#8211; as attributes of a
<code class="docutils literal"><span class="pre">Form</span></code> class. Each field is required by default, so to make <code class="docutils literal"><span class="pre">email</span></code>
optional, we specify <code class="docutils literal"><span class="pre">required=False</span></code>.</p>
<p>Let&#8217;s hop into the Python interactive interpreter and see what this class can
do. The first thing it can do is display itself as HTML:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mysite.forms</span> <span class="kn">import</span> <span class="n">ContactForm</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="go">&lt;tr&gt;&lt;th&gt;&lt;label for=&quot;id_subject&quot;&gt;Subject:&lt;/label&gt;&lt;/th&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;subject&quot; id=&quot;id_subject&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="go">&lt;tr&gt;&lt;th&gt;&lt;label for=&quot;id_email&quot;&gt;Email:&lt;/label&gt;&lt;/th&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;id_email&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="go">&lt;tr&gt;&lt;th&gt;&lt;label for=&quot;id_message&quot;&gt;Message:&lt;/label&gt;&lt;/th&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;message&quot; id=&quot;id_message&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;</span>
</pre></div>
</div>
<p>Django adds a label to each field, along with <code class="docutils literal"><span class="pre">&lt;label&gt;</span></code> tags for
accessibility. The idea is to make the default behavior as optimal as possible.</p>
<p>This default output is in the format of an HTML <code class="docutils literal"><span class="pre">&lt;table&gt;</span></code>, but there are a
few other built-in outputs:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">as_ul</span><span class="p">())</span>
<span class="go">&lt;li&gt;&lt;label for=&quot;id_subject&quot;&gt;Subject:&lt;/label&gt; &lt;input type=&quot;text&quot; name=&quot;subject&quot; id=&quot;id_subject&quot; /&gt;&lt;/li&gt;</span>
<span class="go">&lt;li&gt;&lt;label for=&quot;id_email&quot;&gt;Email:&lt;/label&gt; &lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;id_email&quot; /&gt;&lt;/li&gt;</span>
<span class="go">&lt;li&gt;&lt;label for=&quot;id_message&quot;&gt;Message:&lt;/label&gt; &lt;input type=&quot;text&quot; name=&quot;message&quot; id=&quot;id_message&quot; /&gt;&lt;/li&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">as_p</span><span class="p">())</span>
<span class="go">&lt;p&gt;&lt;label for=&quot;id_subject&quot;&gt;Subject:&lt;/label&gt; &lt;input type=&quot;text&quot; name=&quot;subject&quot; id=&quot;id_subject&quot; /&gt;&lt;/p&gt;</span>
<span class="go">&lt;p&gt;&lt;label for=&quot;id_email&quot;&gt;Email:&lt;/label&gt; &lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;id_email&quot; /&gt;&lt;/p&gt;</span>
<span class="go">&lt;p&gt;&lt;label for=&quot;id_message&quot;&gt;Message:&lt;/label&gt; &lt;input type=&quot;text&quot; name=&quot;message&quot; id=&quot;id_message&quot; /&gt;&lt;/p&gt;</span>
</pre></div>
</div>
<p>Note that the opening and closing <code class="docutils literal"><span class="pre">&lt;table&gt;</span></code>, <code class="docutils literal"><span class="pre">&lt;ul&gt;</span></code> and <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> tags
aren&#8217;t included in the output, so that you can add any additional rows and
customization if necessary.</p>
<p>These methods are just shortcuts for the common case of &#8220;display the entire
form.&#8221; You can also display the HTML for a particular field:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">])</span>
<span class="go">&lt;input id=&quot;id_subject&quot; name=&quot;subject&quot; type=&quot;text&quot; /&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">f</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span>
<span class="go">&lt;input id=&quot;id_message&quot; name=&quot;message&quot; type=&quot;text&quot; /&gt;</span>
</pre></div>
</div>
<p>The second thing <code class="docutils literal"><span class="pre">Form</span></code> objects can do is validate data. To validate data,
create a new <code class="docutils literal"><span class="pre">Form</span></code> object and pass it a dictionary of data that maps field
names to data:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">({</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="s">&#39;Hello&#39;</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="s">&#39;adrian@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Nice site!&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Once you&#8217;ve associated data with a <code class="docutils literal"><span class="pre">Form</span></code> instance, you&#8217;ve created a &#8220;bound&#8221;
form:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">is_bound</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Call the <code class="docutils literal"><span class="pre">is_valid()</span></code> method on any bound <code class="docutils literal"><span class="pre">Form</span></code> to find out whether its
data is valid. We&#8217;ve passed a valid value for each field, so the <code class="docutils literal"><span class="pre">Form</span></code> in
its entirety is valid:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
<span class="go">True</span>
</pre></div>
</div>
<p>If we don&#8217;t pass the <code class="docutils literal"><span class="pre">email</span></code> field, it&#8217;s still valid, because we&#8217;ve specified
<code class="docutils literal"><span class="pre">required=False</span></code> for that field:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">({</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="s">&#39;Hello&#39;</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Nice site!&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
<span class="go">True</span>
</pre></div>
</div>
<p>But, if we leave off either <code class="docutils literal"><span class="pre">subject</span></code> or <code class="docutils literal"><span class="pre">message</span></code>, the <code class="docutils literal"><span class="pre">Form</span></code> is no
longer valid:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">({</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="s">&#39;Hello&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">({</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="s">&#39;Hello&#39;</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
<span class="go">False</span>
</pre></div>
</div>
<p>You can drill down to get field-specific error messages:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">({</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="s">&#39;Hello&#39;</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">errors</span>
<span class="go">[&#39;This field is required.&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">errors</span>
<span class="go">[]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">errors</span>
<span class="go">[]</span>
</pre></div>
</div>
<p>Each bound <code class="docutils literal"><span class="pre">Form</span></code> instance has an <code class="docutils literal"><span class="pre">errors</span></code> attribute that gives you a
dictionary mapping field names to error-message lists:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">({</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="s">&#39;Hello&#39;</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">errors</span>
<span class="go">{&#39;message&#39;: [&#39;This field is required.&#39;]}</span>
</pre></div>
</div>
<p>Finally, for <code class="docutils literal"><span class="pre">Form</span></code> instances whose data has been found to be valid, a
<code class="docutils literal"><span class="pre">cleaned_data</span></code> attribute is available. This is a dictionary of the
submitted data, &#8220;cleaned up.&#8221; Django&#8217;s forms framework not only validates
data, it cleans it up by converting values to the appropriate Python types:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">({</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="s">&#39;Hello&#39;</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="s">&#39;adrian@example.com&#39;</span><span class="p">,</span>
<span class="go">&#39;message&#39;: &#39;Nice site!&#39;})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">cleaned_data</span>
<span class="go">{&#39;message&#39;: &#39;Nice site!&#39;, &#39;email&#39;: &#39;adrian@example.com&#39;, &#39;subject&#39;:</span>
<span class="go">&#39;Hello&#39;}</span>
</pre></div>
</div>
<p>Our contact form only deals with strings, which are &#8220;cleaned&#8221; into string
objects &#8211; but if we were to use an <code class="docutils literal"><span class="pre">IntegerField</span></code> or <code class="docutils literal"><span class="pre">DateField</span></code>, the
forms framework would ensure that <code class="docutils literal"><span class="pre">cleaned_data</span></code> used proper Python
integers or <code class="docutils literal"><span class="pre">datetime.date</span></code> objects for the given fields.</p>
</div>
</div>
<div class="section" id="tying-form-objects-into-views">
<h2>Tying Form Objects Into Views<a class="headerlink" href="#tying-form-objects-into-views" title="Permalink to this headline">¶</a></h2>
<p>Our contact form is not much good to us unless we have some way of displaying
it to the user. To do this, we need to first update our <code class="docutils literal"><span class="pre">mysite/views</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># views.py</span>

<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">mysite.forms</span> <span class="kn">import</span> <span class="n">ContactForm</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">send_mail</span>

<span class="c"># ...</span>

<span class="k">def</span> <span class="nf">contact</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
            <span class="n">send_mail</span><span class="p">(</span>
                <span class="n">cd</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">],</span>
                <span class="n">cd</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">],</span>
                <span class="n">cd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="s">&#39;noreply@example.com&#39;</span><span class="p">),</span>
                <span class="p">[</span><span class="s">&#39;siteowner@example.com&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&#39;/contact/thanks/&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;contact_form.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
</pre></div>
</div>
<p>Next, we have to create our contact form (save this to <code class="docutils literal"><span class="pre">mysite/templates</span></code>):</p>
<div class="highlight-python"><div class="highlight"><pre># contact_form.html

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Contact us&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Contact us&lt;/h1&gt;

    {% if form.errors %}
        &lt;p style=&quot;color: red;&quot;&gt;
            Please correct the error{{ form.errors|pluralize }} below.
        &lt;/p&gt;
    {% endif %}

    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;table&gt;
            {{ form.as_table }}
        &lt;/table&gt;
        {% csrf_token %}
        &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>And finally, we need to change our <code class="docutils literal"><span class="pre">urls.py</span></code> to display our contact form at
<code class="docutils literal"><span class="pre">/contact/</span></code>.</p>
<pre class="literal-block">
 # ...
 from mysite.views import hello, current_datetime, hours_ahead, <strong>contact</strong>

 urlpatterns = [

     # ...

     <strong>url(r'^contact/$', contact),</strong>
]
</pre>
<p>Since we&#8217;re creating a POST form (which can have the effect of modifying data),
we need to worry about Cross Site Request Forgeries. Thankfully, you don&#8217;t have
to worry too hard, because Django comes with a very easy-to-use system for
protecting against it. In short, all POST forms that are targeted at internal
URLs should use the <code class="docutils literal"><span class="pre">{%</span> <span class="pre">csrf_token</span> <span class="pre">%}</span></code> template tag. More details about
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">csrf_token</span> <span class="pre">%}</span></code> can be found in Chapter 21.</p>
<p>Try running this locally. Load the form, submit it with none of the fields
filled out, submit it with an invalid e-mail address, then finally submit it
with valid data. (Of course, unless you have configured a mail-server, you
will get a <code class="docutils literal"><span class="pre">ConnectionRefusedError</span></code> when <code class="docutils literal"><span class="pre">send_mail()</span></code> is called, but
that&#8217;s another issue.)</p>
<p>Finally, if you are feeling clever enough to configure a mail-server (Appendix
H shows you how to do this), you will need to write the view at
<code class="docutils literal"><span class="pre">contact/thanks</span></code>.</p>
</div>
<div class="section" id="changing-how-fields-are-rendered">
<h2>Changing How Fields Are Rendered<a class="headerlink" href="#changing-how-fields-are-rendered" title="Permalink to this headline">¶</a></h2>
<p>Probably the first thing you&#8217;ll notice when you render this form locally is
that the <code class="docutils literal"><span class="pre">message</span></code> field is displayed as an <code class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=&quot;text&quot;&gt;</span></code>, and it
ought to be a <code class="docutils literal"><span class="pre">&lt;textarea&gt;</span></code>. We can fix that by setting the field&#8217;s <em>widget</em>:</p>
<pre class="literal-block">
from django import forms

class ContactForm(forms.Form):
    subject = forms.CharField()
    email = forms.EmailField(required=False)
    message = forms.CharField(<strong>widget=forms.Textarea</strong>)
</pre>
<p>The forms framework separates out the presentation logic for each field into a
set of widgets. Each field type has a default widget, but you can easily
override the default, or provide a custom widget of your own.</p>
<p>Think of the <code class="docutils literal"><span class="pre">Field</span></code> classes as representing <em>validation logic</em>, while
widgets represent <em>presentation logic</em>.</p>
</div>
<div class="section" id="setting-a-maximum-length">
<h2>Setting a Maximum Length<a class="headerlink" href="#setting-a-maximum-length" title="Permalink to this headline">¶</a></h2>
<p>One of the most common validation needs is to check that a field is of a
certain size. For good measure, we should improve our <code class="docutils literal"><span class="pre">ContactForm</span></code> to limit
the <code class="docutils literal"><span class="pre">subject</span></code> to 100 characters. To do that, just supply a <code class="docutils literal"><span class="pre">max_length</span></code> to
the <code class="docutils literal"><span class="pre">CharField</span></code>, like this:</p>
<pre class="literal-block">
from django import forms

class ContactForm(forms.Form):
    subject = forms.CharField(<strong>max_length=100</strong>)
    email = forms.EmailField(required=False)
    message = forms.CharField(widget=forms.Textarea)
</pre>
<p>An optional <code class="docutils literal"><span class="pre">min_length</span></code> argument is also available.</p>
</div>
<div class="section" id="setting-initial-values">
<h2>Setting Initial Values<a class="headerlink" href="#setting-initial-values" title="Permalink to this headline">¶</a></h2>
<p>As an improvement to this form, let&#8217;s add an <em>initial value</em> for the
<code class="docutils literal"><span class="pre">subject</span></code> field: <code class="docutils literal"><span class="pre">&quot;I</span> <span class="pre">love</span> <span class="pre">your</span> <span class="pre">site!&quot;</span></code> (A little power of suggestion can&#8217;t
hurt.) To do this, we can use the <code class="docutils literal"><span class="pre">initial</span></code> argument when we create a
<code class="docutils literal"><span class="pre">Form</span></code> instance:</p>
<pre class="literal-block">
def contact(request):
    if request.method == 'POST':
        form = ContactForm(request.POST)
        if form.is_valid():
            cd = form.cleaned_data
            send_mail(
                cd['subject'],
                cd['message'],
                cd.get('email', <a class="reference external" href="mailto:'noreply&#37;&#52;&#48;example&#46;com">'noreply<span>&#64;</span>example<span>&#46;</span>com</a>'),
                [<a class="reference external" href="mailto:'siteowner&#37;&#52;&#48;example&#46;com">'siteowner<span>&#64;</span>example<span>&#46;</span>com</a>'],
            )
            return HttpResponseRedirect('/contact/thanks/')
    else:
        form = ContactForm(
            <strong>initial={'subject': 'I love your site!'}</strong>
        )
    return render(request, 'contact_form.html', {'form': form})
</pre>
<p>Now, the <code class="docutils literal"><span class="pre">subject</span></code> field will be displayed prepopulated with that kind
statement.</p>
<p>Note that there is a difference between passing <em>initial</em> data and passing
data that <em>binds</em> the form. The biggest difference is that if you&#8217;re just
passing <em>initial</em> data, then the form will be <em>unbound</em>, which means it won&#8217;t
have any error messages.</p>
</div>
<div class="section" id="custom-validation-rules">
<h2>Custom Validation Rules<a class="headerlink" href="#custom-validation-rules" title="Permalink to this headline">¶</a></h2>
<p>Imagine we&#8217;ve launched our feedback form, and the e-mails have started tumbling
in. There&#8217;s just one problem: some of the submitted messages are just one or
two words, which isn&#8217;t long enough for us to make sense of. We decide to adopt
a new validation policy: four words or more, please.</p>
<p>There are a number of ways to hook custom validation into a Django form. If our
rule is something we will reuse again and again, we can create a custom field
type. Most custom validations are one-off affairs, though, and can be tied
directly to the <code class="docutils literal"><span class="pre">Form</span></code> class.</p>
<p>We want additional validation on the <code class="docutils literal"><span class="pre">message</span></code> field, so we add a
<code class="docutils literal"><span class="pre">clean_message()</span></code> method to our <code class="docutils literal"><span class="pre">Form</span></code> class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="k">class</span> <span class="nc">ContactForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">Textarea</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span>
        <span class="n">num_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">num_words</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Not enough words!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span>
</pre></div>
</div>
<p>Django&#8217;s form system automatically looks for any method whose name starts with
<code class="docutils literal"><span class="pre">clean_</span></code> and ends with the name of a field. If any such method exists, it&#8217;s
called during validation.</p>
<p>Specifically, the <code class="docutils literal"><span class="pre">clean_message()</span></code> method will be called <em>after</em> the default
validation logic for a given field (in this case, the validation logic for a
required <code class="docutils literal"><span class="pre">CharField</span></code>). Because the field data has already been partially
processed, we pull it out of <code class="docutils literal"><span class="pre">self.cleaned_data</span></code>. Also, we don&#8217;t have to
worry about checking that the value exists and is non-empty; that&#8217;s done by the
default validator.</p>
<p>We naively use a combination of <code class="docutils literal"><span class="pre">len()</span></code> and <code class="docutils literal"><span class="pre">split()</span></code> to count the number
of words. If the user has entered too few words, we raise a
<code class="docutils literal"><span class="pre">forms.ValidationError</span></code>. The string attached to this exception will be
displayed to the user as an item in the error list.</p>
<p>It&#8217;s important that we explicitly return the cleaned value for the field at the
end of the method. This allows us to modify the value (or convert it to a
different Python type) within our custom validation method. If we forget the
return statement, then <code class="docutils literal"><span class="pre">None</span></code> will be returned, and the original value will
be lost.</p>
<p>For more on Django&#8217;s validation tools, see Appendix H.</p>
</div>
<div class="section" id="specifying-labels">
<h2>Specifying labels<a class="headerlink" href="#specifying-labels" title="Permalink to this headline">¶</a></h2>
<p>By default, the labels on Django&#8217;s auto-generated form HTML are created by
replacing underscores with spaces and capitalizing the first letter &#8211; so the
label for the <code class="docutils literal"><span class="pre">email</span></code> field is <code class="docutils literal"><span class="pre">&quot;Email&quot;</span></code>. (Sound familiar? It&#8217;s the same
simple algorithm that Django&#8217;s models use to calculate default <code class="docutils literal"><span class="pre">verbose_name</span></code>
values for fields. We covered this in Chapter 4.)</p>
<p>But, as with Django&#8217;s models, we can customize the label for a given field.
Just use <code class="docutils literal"><span class="pre">label</span></code>, like so:</p>
<pre class="literal-block">
class ContactForm(forms.Form):
    subject = forms.CharField(max_length=100)
    email = forms.EmailField(required=False, <strong>label='Your e-mail address'</strong>)
    message = forms.CharField(widget=forms.Textarea)
</pre>
</div>
<div class="section" id="customizing-form-design">
<h2>Customizing Form Design<a class="headerlink" href="#customizing-form-design" title="Permalink to this headline">¶</a></h2>
<p>Our <code class="docutils literal"><span class="pre">contact_form.html</span></code> template uses <code class="docutils literal"><span class="pre">{{</span> <span class="pre">form.as_table</span> <span class="pre">}}</span></code> to display the
form, but we can display the form in other ways to get more granular control
over display.</p>
<p>The quickest way to customize forms&#8217; presentation is with CSS. Error lists, in
particular, could do with some visual enhancement, and the auto-generated error
lists use <code class="docutils literal"><span class="pre">&lt;ul</span> <span class="pre">class=&quot;errorlist&quot;&gt;</span></code> precisely so that you can target them with
CSS. The following CSS really makes our errors stand out:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;style type=&quot;text/css&quot;&gt;
    ul.errorlist {
        margin: 0;
        padding: 0;
    }
    .errorlist li {
        background-color: red;
        color: white;
        display: block;
        font-size: 10px;
        margin: 0 0 3px;
        padding: 4px 5px;
    }
&lt;/style&gt;
</pre></div>
</div>
<p>While it&#8217;s convenient to have our form&#8217;s HTML generated for us, in many
cases you&#8217;ll want to override the default rendering. <code class="docutils literal"><span class="pre">{{</span> <span class="pre">form.as_table</span> <span class="pre">}}</span></code>
and friends are useful shortcuts while you develop your application, but
everything about the way a form is displayed can be overridden, mostly within
the template itself, and you&#8217;ll probably find yourself doing this.</p>
<p>Each field&#8217;s widget (<code class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=&quot;text&quot;&gt;</span></code>, <code class="docutils literal"><span class="pre">&lt;select&gt;</span></code>, <code class="docutils literal"><span class="pre">&lt;textarea&gt;</span></code>,
etc.) can be rendered individually by accessing <code class="docutils literal"><span class="pre">{{</span> <span class="pre">form.fieldname</span> <span class="pre">}}</span></code> in the
template, and any errors associated with a field are available as
<code class="docutils literal"><span class="pre">{{</span> <span class="pre">form.fieldname.errors</span> <span class="pre">}}</span></code>. With this in mind, we can construct a custom
template for our contact form with the following template code:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Contact us&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Contact us&lt;/h1&gt;

    {% if form.errors %}
        &lt;p style=&quot;color: red;&quot;&gt;
            Please correct the error{{ form.errors|pluralize }} below.
        &lt;/p&gt;
    {% endif %}

    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;div class=&quot;field&quot;&gt;
            {{ form.subject.errors }}
            &lt;label for=&quot;id_subject&quot;&gt;Subject:&lt;/label&gt;
            {{ form.subject }}
        &lt;/div&gt;
        &lt;div class=&quot;field&quot;&gt;
            {{ form.email.errors }}
            &lt;label for=&quot;id_email&quot;&gt;Your e-mail address:&lt;/label&gt;
            {{ form.email }}
        &lt;/div&gt;
        &lt;div class=&quot;field&quot;&gt;
            {{ form.message.errors }}
            &lt;label for=&quot;id_message&quot;&gt;Message:&lt;/label&gt;
            {{ form.message }}
        &lt;/div&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">{{</span> <span class="pre">form.message.errors</span> <span class="pre">}}</span></code> displays a <code class="docutils literal"><span class="pre">&lt;ul</span> <span class="pre">class=&quot;errorlist&quot;&gt;</span></code> if errors
are present and a blank string if the field is valid (or the form is unbound).
We can also treat <code class="docutils literal"><span class="pre">form.message.errors</span></code> as a Boolean or even iterate
over it as a list. For example:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;div class=&quot;field{% if form.message.errors %} errors{% endif %}&quot;&gt;
    {% if form.message.errors %}
        &lt;ul&gt;
        {% for error in form.message.errors %}
            &lt;li&gt;&lt;strong&gt;{{ error }}&lt;/strong&gt;&lt;/li&gt;
        {% endfor %}
        &lt;/ul&gt;
    {% endif %}
    &lt;label for=&quot;id_message&quot;&gt;Message:&lt;/label&gt;
    {{ form.message }}
&lt;/div&gt;
</pre></div>
</div>
<p>In the case of validation errors, this will add an &#8220;errors&#8221; class to the
containing <code class="docutils literal"><span class="pre">&lt;div&gt;</span></code> and display the list of errors in an unordered list.</p>
</div>
<div class="section" id="what-s-next">
<h2>What&#8217;s Next?<a class="headerlink" href="#what-s-next" title="Permalink to this headline">¶</a></h2>
<p>This chapter concludes the introductory material in this book &#8211; the so-called
&#8220;core curriculum.&#8221; The next section of the book, Chapters 7 to 13, goes into
more detail about advanced Django usage, including how to deploy a Django
application (Chapter 13).</p>
<p>After these first seven chapters, you should know enough to start writing your
own Django projects. The rest of the material in this book will help fill in the
missing pieces as you need them.</p>
<p>We&#8217;ll start in Chapter 7, by doubling back and taking a closer look at views
and URLconfs (introduced first in Chapter 2).</p>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="front_matter.html">About this book</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction_3e.html">Introduction to the third edition</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_01.html">Chapter 1: Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_02.html">Chapter 2: Views and URLconfs</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_03.html">Chapter 3: Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_04.html">Chapter 4: Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_05.html">Chapter 5: The Django Admin Site</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Chapter 6: Forms</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter_07.html">Chapter 7: Advanced Views and URLconfs</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_08.html">Chapter 8: Advanced Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_09.html">Chapter 9: Advanced Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_10.html">Chapter 10: Generic Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_11.html">Chapter 11: User authentication in Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_12.html">Chapter 12 - testing in Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_13.html">Chapter 13: Deploying Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_14.html">Chapter 14 - How to write reusable apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_15.html">Chapter 15: Generating Non-HTML Content</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_16.html">Chapter 16 - Django sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_17.html">Chapter 17 - Django&#8217;s cache framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_18.html">Chapter 18 - Other core Django functionalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_19.html">Chapter 19 - Django Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_19.html#module-django.middleware">Middleware</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_20.html">Chapter 20: Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_21.html">Chapter 21: Security in Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_A.html">Appendix A: Model Definition Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_B.html">Appendix B: Database API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_C.html">Appendix C: Generic View Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_C.html#using-mixins-with-class-based-views">Using mixins with class-based views</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_D.html">Appendix D: Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_E.html">Appendix E: Built-in Template Tags and Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_F.html">Appendix F: The django-admin Utility</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_F.html#running-management-commands-from-your-code">Running management commands from your code</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_G.html">Appendix G: Request and Response Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License &amp; Copyright</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
            <p class="searchtip" style="font-size: 90%">
                Enter search terms or a module, class or function name.
            </p>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="chapter_05.html" title="Chapter 5: The Django Admin Site"
              >previous</a> |
            <a href="chapter_07.html" title="Chapter 7: Advanced Views and URLconfs"
              >next</a> |
            <a href="py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
              <br/>
              <a href="_sources/chapter_06.txt"
                rel="nofollow">Show Source</a>
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Nigel George.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>